"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,s,t,a){void 0===a&&(a=t),Object.defineProperty(e,a,{enumerable:!0,get:function(){return s[t]}})}:function(e,s,t,a){e[a=void 0===a?t:a]=s[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,s){Object.defineProperty(e,"default",{enumerable:!0,value:s})}:function(e,s){e.default=s}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var s={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(s,e,t);return __setModuleDefault(s,e),s},__awaiter=this&&this.__awaiter||function(e,d,n,i){return new(n=n||Promise)(function(t,s){function a(e){try{r(i.next(e))}catch(e){s(e)}}function o(e){try{r(i.throw(e))}catch(e){s(e)}}function r(e){var s;e.done?t(e.value):((s=e.value)instanceof n?s:new n(function(e){e(s)})).then(a,o)}r((i=i.apply(e,d||[])).next())})},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const crypto=__importStar(require("crypto")),authadmin_model_1=require("../../../modules/auth/models/authadmin_model"),user_model_1=require("../../../modules/auth/models/user_model"),bodysingup_1=__importDefault(require("../../../modules/auth/schemas/bodysingup")),singinSchema_1=__importDefault(require("../../../modules/auth/schemas/singinSchema")),changepasswordSchema_1=__importDefault(require("../../../modules/auth/schemas/changepasswordSchema")),changeemailSchema_1=__importDefault(require("../../../modules/auth/schemas/changeemailSchema")),accesstokenSchema_1=__importDefault(require("../schemas/accesstokenSchema")),path=__importStar(require("path")),envPath=path.join(__dirname,"../configrouter.conf");require("dotenv").config({path:envPath});const env=process.env,opts={},TIMEEXPIRE1=env.TIMEEXPIRE,TIMEEXPIRE=env.TIMEEXPIRE_TOKEN,mode=env.mode,client_id=env.client_id,access_token_key=env.access_token_key,secret_key=env.secret_key,scopenumber=env.scopenumber,EmailValidator=__importStar(require("email-validator"));function auth(O){return __awaiter(this,void 0,void 0,function*(){const x=new user_model_1.UserModel,S=(new authadmin_model_1.AuthadminModel,O.db1);function j(e){return e.match("^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#$%^&*])(?=.{8,})")?(console.log("Your validate password  Correct, try another...:"+e),!0):(console.log("You validate password Wrong...:"+e),!1)}function C(e){var s="0123456789",t="ABCDEFGHIJKLMNOPQRSTUVWXYZ",a="abcdefghijklmnopqrstuvwxyz",e=Array(e);return e[0]=s,e[1]=t,e[2]=a,function(e){for(var s=e.length-1;0<s;s--){var t=Math.floor(Math.random()*(s+1)),a=e[s];e[s]=e[t],e[t]=a}return e}((e=e.fill("0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz!@#$%^&*",3)).map(function(e){return e[Math.floor(Math.random()*e.length)]})).join("")}function G(e){for(var s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()_+",t="",a=0;a<e;a++)t+=s.charAt(Math.floor(Math.random()*s.length));return t}O.get("/",(e,s)=>__awaiter(this,void 0,void 0,function*(){var e=env.mode;s.header("version",1),s.header("x-cache-status",0),s.header("Cache-Control","private, no-cache, no-store, must-revalidate"),s.header("Expires","-1"),s.header("Pragma","no-cache"),s.header("Access-Control-Allow-Methods","GET,POST,PUT"),s.header("message","Working"),1==e?(s.header("status",!0),s.header("statusCode",200),s.header("code",200),s.code(200).send({title:{status:!0,statusCode:200,mode:"service"},status:!0,statusCode:200,statusrun:1,cache:"no cache",nameservice:"Micro service tppy-tcas",message:"The system works in normal mode.",message_th:"ระบบทำงาน ในโหมดปกติ"})):(s.header("status",!1),s.header("statusCode",500),s.header("code",500),s.code(500).send({title:{status:!1,statusCode:500,mode:"Maintenance mode"},status:!1,statusCode:500,statusrun:0,cache:"no cache",nameservice:"Micro service tppy-tcas",message:"Maintenance mode , Sorry for the inconvenience",message_th:"อยู่ระหว่างปรับปรุงระบบ ขออภัยความไม่สะดวก"}))})),O.post("/",(e,a)=>__awaiter(this,void 0,void 0,function*(){var e=env.mode;if(a.header("version",1),a.header("x-cache-status",0),a.header("Cache-Control","private, no-cache, no-store, must-revalidate"),a.header("Expires","-1"),a.header("Pragma","no-cache"),a.header("Access-Control-Allow-Methods","GET,POST,PUT"),a.header("message","Working"),1==e){a.header("status",!0),a.header("statusCode",200),a.header("code",200);var s=O.jwt.sign({name:"demo"},{expiresIn:"1days"}),e=O.jwt.decode(s);const t={};t.token=s,t.decoded=e,t.expirein="1days",a.code(200).send({title:{status:!0,statusCode:200,mode:"service"},status:!0,statusCode:200,statusrun:1,cache:"no cache",nameservice:"Micro service tppy-tcas",message:"The system works in normal mode.",message_th:"ระบบทำงาน ในโหมดปกติ",jwtdata:t})}else a.header("status",!1),a.header("statusCode",500),a.header("code",500),a.code(500).send({title:{status:!1,statusCode:500,mode:"Maintenance mode"},status:!1,statusCode:500,statusrun:0,cache:"no cache",nameservice:"Micro service tppy-tcas",message:"Maintenance mode , Sorry for the inconvenience",message_th:"อยู่ระหว่างปรับปรุงระบบ ขออภัยความไม่สะดวก"})})),O.post("/v1",(s,t)=>__awaiter(this,void 0,void 0,function*(){var e=env.mode;try{if(1!=e)return t.header("status",!1),t.header("statusCode",500),t.header("code",500),void t.code(500).send({title:{status:!1,statusCode:500,mode:"Maintenance mode"},status:!1,statusCode:500,statusrun:0,cache:"no cache",nameservice:"Micro service tppy-tcas",message:"Maintenance mode , Sorry for the inconvenience",message_th:"อยู่ระหว่างปรับปรุงระบบ ขออภัยความไม่สะดวก"})}catch(e){}t.header("version",1),t.header("x-cache-status",0),t.header("Cache-Control","private, no-cache, no-store, must-revalidate"),t.header("Expires","-1"),t.header("Pragma","no-cache"),t.header("Pragma","no-cache"),t.header("Access-Control-Allow-Methods","GET,POST,PUT"),t.header("message","Working"),t.header("statusCode",200),t.header("code",200),t.header("status",!0),t.code(200).send({title:{status:!0,statusCode:200,cache:"no cache",message:"Working admin",message_th:"ทำงาน"}}),console.log(s.body)})),O.get("/v1",(s,t)=>__awaiter(this,void 0,void 0,function*(){var e=env.mode;try{if(1!=e)return t.header("status",!1),t.header("statusCode",500),t.header("code",500),void t.code(500).send({title:{status:!1,statusCode:500,mode:"Maintenance mode"},status:!1,statusCode:500,statusrun:0,cache:"no cache",nameservice:"Micro service tppy-tcas",message:"Maintenance mode , Sorry for the inconvenience",message_th:"อยู่ระหว่างปรับปรุงระบบ ขออภัยความไม่สะดวก"})}catch(e){}t.header("version",1),t.header("x-cache-status",0),t.header("Cache-Control","private, no-cache, no-store, must-revalidate"),t.header("Expires","-1"),t.header("Pragma","no-cache"),t.header("Access-Control-Allow-Methods","GET,POST,PUT"),t.header("message","Working"),t.header("statusCode",200),t.header("code",200),t.header("status",!0),t.code(200).send({title:{status:!0,statusCode:200,cache:"no cache",message:"Working admin",message_th:"ทำงาน"}}),console.log(s.body)})),O.get("/authenticateuser",{preValidation:[O.genint]},(e,s)=>__awaiter(this,void 0,void 0,function*(){})),O.get("/genint",{preValidation:[O.genint]},(e,s)=>__awaiter(this,void 0,void 0,function*(){})),O.post("/genint",{preValidation:[O.genint]},(e,s)=>__awaiter(this,void 0,void 0,function*(){})),O.get("/getstate",{preValidation:[O.getstate]},(e,s)=>__awaiter(this,void 0,void 0,function*(){})),O.post("/getstate",{preValidation:[O.getstate]},(e,s)=>__awaiter(this,void 0,void 0,function*(){})),O.get("/clientsecret",{preValidation:[O.clientsecret]},(e,s)=>__awaiter(this,void 0,void 0,function*(){})),O.post("/clientsecret",{preValidation:[O.clientsecret]},(e,s)=>__awaiter(this,void 0,void 0,function*(){})),O.get("/codegenclientid",{preValidation:[O.codegen]},(e,s)=>__awaiter(this,void 0,void 0,function*(){})),O.post("/codegenclientid",{preValidation:[O.codegen]},(e,s)=>__awaiter(this,void 0,void 0,function*(){})),O.post("/singup",{schema:bodysingup_1.default},(P,b)=>__awaiter(this,void 0,void 0,function*(){var e=path.join(__dirname,"../configrouter.conf");require("dotenv").config({path:e});var s=process.env,t=(s.TIMEEXPIRE,s.TIMEEXPIRE_TOKEN),a=(s.mode,s.client_id,s.access_token_key,s.secret_key,s.scopenumber,P.headers),o=P.body,r=(P.query,a.authorization,o.time||t||"10h");const d=o.username;var n=o.password,e=o.debug,s=o.email;if(""===d){const d=o.email}a=o.firstname,t=o.lastname;const i=o.level,c=(o.network_id,o.network_type_id);if(""===c){const c=1}try{if(""===d)return b.header("Access-Control-Allow-Methods","GET"),b.header("message","Information Correct"),b.header("statusCode",500),b.header("status",!1),b.code(500).send({title:{status:!1,statusCode:500,cache:"no cache"},message:"username is null",message_th:"ไม่พบข้อมูล username"}),void console.log(P.body);if(""===n)return b.header("Access-Control-Allow-Methods","GET"),b.header("message","Information Correct"),b.header("statusCode",500),b.header("status",!1),b.code(500).send({title:{status:!1,statusCode:500,cache:"no cache"},message:"password is null",message_th:"ไม่พบข้อมูล password"}),void console.log(P.body);var h=j(n);if(0==h)return b.header("version",1),b.header("x-cache-status",0),b.header("Cache-Control","private, no-cache, no-store, must-revalidate"),b.header("Expires","-1"),b.header("Pragma","no-cache"),b.header("Access-Control-Allow-Methods","GET,POST,PUT"),b.header("message","Password not secure"),b.header("statusCode",500),b.header("code",500),b.header("status",!1),b.header("Password",!1),b.code(500).send({title:{status:!1,statusCode:500,cache:"no cache"},message:"Password not secure ,Please set a new password, English only, with uppercase, lowercase, numbers and special characters.,mix together",message_th:" รหัสผ่าน ไม่ปลอดภัย กรุณาตั้งรหัสผ่านใหม่ เป็นภาษาอังกฤษเท่านั้น ตัวพิมพ์ใหญ่ ตัวพิมพ์เล็ก ตัวเลข และอักขระพิเศษ ผสมกัน"}),void console.log(" passwordrt :"+h);crypto.createHash("md5").update(n).digest("hex");if(""===s)return b.header("Access-Control-Allow-Methods","GET"),b.header("message","Information Correct"),b.header("statusCode",500),b.header("status",!1),b.code(500).send({title:{status:!1,statusCode:500,cache:"no cache"},message:"email is null",message_th:"ไม่พบข้อมูล email"}),void console.log(P.body);if(""===a)return b.header("Access-Control-Allow-Methods","GET"),b.header("message","Information Correct"),b.header("statusCode",500),b.header("status",!1),b.code(500).send({title:{status:!1,statusCode:500,cache:"no cache"},message:"firstname is null",message_th:"ไม่พบข้อมูล firstname"}),void console.log(P.body);if(""===t)return b.code(500).send({title:{status:!1,statusCode:500,cache:"no cache"},message:"lastname is null",message_th:"ไม่พบข้อมูล lastname"}),void console.log(P.body);if(""===i){const i=1}const T=null;var u=new Date,l=EmailValidator.validate(s);if(0==l)return b.header("Access-Control-Allow-Methods","POST"),b.header("statusCode",500),b.header("status",!1),void b.code(500).send({status:!1,statusCode:500,emailchk:l,date:u,message:"This email is Invalid format ",message_th:"รูปแบบ email ไม่ถูกต้อง"});if(0<(yield x.validation_email(S,s)).length)return b.header("Access-Control-Allow-Methods","POST"),b.header("statusCode",500),b.header("status",!1),void b.code(500).send({title:{status:!1,statusCode:500,cache:"no cache"},message:"This email is duplicate data in the database system ",message_th:"email นี้เป็นข้อมูลซ้ำในระบบฐานข้อมูล"});if(0<(yield x.validation_username(S,d)).length)return b.header("Access-Control-Allow-Methods","POST"),b.header("statusCode",500),b.header("status",!1),void b.code(500).send({title:{status:!1,statusCode:500,cache:"no cache"},message:"This username is duplicate data in the database system ",message_th:"username นี้เป็นข้อมูลซ้ำในระบบฐานข้อมูล"});try{var m=crypto.createHash("md5").update(n).digest("hex");const A={};A.username=d,A.password=m,A.password_temp=n,A.firstname=a,A.lastname=t,A.email=s,A.date=u,A.level=i,A.status=1,A.network_id=null,A.network_type_id=c;var g=yield x.create(S,A),v=yield x.lastidread(S),_=v[0],f=_.user_id;if(1==e)return void b.code(500).send({addrs:g,da:v,luser:_,user_idx:f,status_insert:1});var p=require("md5")(f),C=p;const k={};if(k.profile_id=C,2==e)return void b.code(200).send({addrs:g,data_array_update:k,user_idx:f});yield x.where_sd_users_profile_id_update(S,f,k);var w=yield x.login(S,d,m);if(0<w.length){var y=w[0];console.log(y);var E=O.jwt.sign({user_id:y.user_id,profile_id:y.profile_id,level:y.level,username:y.username,email:y.email,firstName:y.firstname,lastName:y.lastname,state:G(32),expirein:r},{expiresIn:r}),M=O.jwt.verify(E);const I={};I.token=E,I.decoded=M,I.expirein=r,b.header("version",1),b.header("x-cache-status",0),b.header("code",200),O.jwt.verify(E,(e,s)=>{e&&O.log.error(e),O.log.info("Token verified. Foo is "+s.foo)});y.user_id,y.username,y.email,y.firstname,y.lastname,y.level;return b.header("Access-Control-Allow-Methods","POST"),b.header("message","Information Correct"),b.header("statusCode",200),b.header("status",!0),void b.send({title:{status:!0,statusCode:200},message:"Register successfully,welcome "+y.firstname+" "+y.lastname+" Sign in system successfully",message_th:"ลงทะเบียนสำเร็จ ,ยินดีต้อนรับ คุณ "+y.firstname+" "+y.lastname+" เข้าสู่ระบบสำเร็จ",profile_id:p,token:E})}return void b.code(401).send({title:{status:!1,statusCode:401},message:"Login failed!",message_th:"ไม่พบข้อมูล username หรือ password ในระบบ"})}catch(e){return console.log(e),b.header("Access-Control-Allow-Methods","POST"),b.header("statusCode",500),b.header("status",!1),b.header("message",e),void b.code(500).send({title:{status:!1,statusCode:500,cache:"no cache"},message:"register failed active code 500 error!",message_th:" ไม่สามารถลงทะเบียนได้",error:e})}}catch(e){return console.log(e),b.header("Access-Control-Allow-Methods","POST"),b.header("statusCode",500),b.header("status",!1),b.header("message",e),void b.code(500).send({title:{status:!1,statusCode:500},message:e})}})),O.post("/singin",{schema:singinSchema_1.default},(g,v)=>__awaiter(this,void 0,void 0,function*(){var e=path.join(__dirname,"../configrouter.conf");require("dotenv").config({path:e});var s=process.env,t=(s.TIMEEXPIRE,s.TIMEEXPIRE_TOKEN),a=(s.mode,s.client_id,s.access_token_key,s.secret_key),o=(s.scopenumber,g.headers),r=g.body,d=(g.query,o.authorization,r.time||t||"10h"),e=s.mode,o=r.username,t=r.password;try{if(1!=e)return v.header("status",!1),v.header("statusCode",500),v.header("code",500),void v.code(500).send({title:{status:!1,statusCode:500,mode:"Maintenance mode"},status:!1,statusCode:500,statusrun:0,cache:"no cache",nameservice:"Micro service tppy-tcas",message:"Maintenance mode , Sorry for the inconvenience",message_th:"อยู่ระหว่างปรับปรุงระบบ ขออภัยความไม่สะดวก"});var n=r.secret_key;if(null===n)return v.header("accesstoken",""),v.header("statusCode",500),v.header("status",!1),v.header("message","forbidden access"),void v.code(500).send({message:"secret_key is empty ,forbidden access ",message_th:"ไม่พบ secret_key ไม่อนุญาตให้เข้าถึง ระบบ"});if(n!=a)return v.header("accesstoken",""),v.header("statusCode",500),v.header("status",!1),v.header("message","forbidden access"),void v.code(500).send({message:"secret_key is incorrect ,forbidden access ",message_th:"secret_key ไม่ถูกต้อง ไม่อนุญาตให้เข้าถึง"});if(""==o)return v.header("Access-Control-Allow-Methods","GET"),v.header("message","Information Correct"),v.header("statusCode",500),v.header("status",!1),v.code(500).send({title:{status:!1,statusCode:500},message:"username is null",message_th:"ไม่พบข้อมูล username"}),void console.log(g.body);if(""==t)return v.header("Access-Control-Allow-Methods","GET"),v.header("message","Information Correct"),v.header("statusCode",500),v.header("status",!1),v.code(500).send({title:{status:!1,statusCode:500},message:"password is null",message_th:"ไม่พบข้อมูล password"}),void console.log(g.body);var i=crypto.createHash("md5").update(t).digest("hex"),c=yield x.login(S,o,i);if(0<c.length){var h=c[0];console.log(h);var u=O.jwt.sign({user_id:h.user_id,profile_id:h.profile_id,level:h.level,username:h.username,email:h.email,firstName:h.firstname,lastName:h.lastname,state:G(32),expirein:d},{expiresIn:d}),l=O.jwt.verify(u);const m={};m.token=u,m.decoded=l,m.expirein=d,v.header("version",1),v.header("x-cache-status",0),v.header("code",200),O.jwt.verify(u,(e,s)=>{e&&O.log.error(e),O.log.info("Token verified. Foo is "+s.foo)});h.user_id,h.username,h.email,h.firstname,h.lastname,h.level;return v.header("Access-Control-Allow-Methods","GET"),v.header("message","Information Correct"),v.header("statusCode",200),v.header("status",!0),void v.send({title:{status:!0,statusCode:200,cache:"no cache"},message:"welcome "+h.firstname+" "+h.lastname+" Sign in system successfully",message_th:"ยินดีต้อนรับ คุณ "+h.firstname+" "+h.lastname+" เข้าสู่ระบบสำเร็จ",timeset:"10h",token:u})}return void v.code(401).send({title:{status:!0,statusCode:200,cache:"no cache"},message:"Login failed!",message_th:"ไม่พบข้อมูล username หรือ password ในระบบ",TIMEEXPIRE:s.TIMEEXPIRE})}catch(e){return console.log(e),v.header("Access-Control-Allow-Methods","GET"),v.header("message","Information Correct"),v.header("statusCode",500),v.header("status",!1),void v.code(500).send({title:{status:!1,statusCode:500,cache:"no cache"},message:e,TIMEEXPIRE:s.TIMEEXPIRE})}})),O.post("/resetpass",(m,g)=>__awaiter(this,void 0,void 0,function*(){var e=env.mode;try{if(1!=e)return g.header("status",!1),g.header("statusCode",500),g.header("code",500),void g.code(500).send({title:{status:!1,statusCode:500,mode:"Maintenance mode"},status:!1,statusCode:500,statusrun:0,cache:"no cache",nameservice:"Micro service tppy-tcas",message:"Maintenance mode , Sorry for the inconvenience",message_th:"อยู่ระหว่างปรับปรุงระบบ ขออภัยความไม่สะดวก"});if(911==e)return g.header("status",!1),g.header("statusCode",500),g.header("code",500),void g.code(500).send({title:{status:!1,statusCode:500,mode:"Maintenance mode"},status:!1,statusCode:500,statusrun:0,cache:"no cache",nameservice:"Micro service tppy-tcas",message:"Maintenance mode , Sorry for the inconvenience",message_th:"อยู่ระหว่างปรับปรุงระบบ ขออภัยความไม่สะดวก หรือปิดการใช้งาน"})}catch(e){}e=m.body.reset_valule;try{if(""===e)return g.header("Access-Control-Allow-Methods","GET"),g.header("message","Information Correct"),g.header("statusCode",500),g.header("status",!1),g.code(500).send({title:{status:!1,statusCode:500},message:"username or email is null",message_th:"ไม่พบข้อมูล username หรือ email"}),void console.log(m.body);var s=yield x.resetPassword(S,e);if(0<s.length){var t=s[0],a=env.TIMEEXPIRE,o=(env.TIMEEXPIRE,env.TIMEEXPIRE),r=new Date,d=r.getFullYear()+"-"+(r.getMonth()+1)+"-"+r.getDate()+" "+(r.getHours()+":"+r.getMinutes()+":"+r.getSeconds()),n=Date.now(),i=(Date.now(),O.jwt.sign({user_id:t.user_id,level:t.level,username:t.username,email:t.email,at:{startdate:d,issued_at:n,timeconfig:a,TIMEEXPIRE_TOKEN:env.TIMEEXPIRE_TOKEN,state:G(32)}})),c=(O.jwt.verify(i),C(20)),h=c,u=crypto.createHash("md5").update(h).digest("hex");const l={};return l.password_temp=h,l.password=u,yield x.where_user_update_password_or(S,e,l),g.header("Access-Control-Allow-Methods","GET"),g.header("message","Information Correct"),g.header("statusCode",200),g.header("status",!0),g.send({title:{status:!0,statusCode:200},message:"Reset password username "+t.username+" email "+t.email+" new password is "+c,message_th:"ข้อมูลลืมรหัสผ่าน "+t.username+" email "+t.email+" รหัสผ่านใหม่คือ "+c,newpassword:c,data:i,TIMEEXPIRE:o,input:{reset_valule:e}}),void console.log("query result :"+s)}return g.header("Access-Control-Allow-Methods","GET"),g.header("message","Information Correct"),g.header("statusCode",401),g.header("code",401),g.header("status",!1),void g.code(401).send({title:{status:!1,statusCode:401},message:"username or email is do not have in database",message_th:"ไม่พบข้อมูล username หรือ email ในระบบฐานข้อมูล",data:null,input:{reset_valule:e}})}catch(e){console.log(e),g.code(500).send({title:{status:!1,statusCode:500},message:e+" ไม่พบข้อมูล username หรือ email ในระบบฐานข้อมูล"})}})),O.post("/changepassword",{preValidation:[O.authenticate],schema:changepasswordSchema_1.default},(f,p)=>__awaiter(this,void 0,void 0,function*(){var e=env.mode;try{if(1!=e)return p.header("status",!1),p.header("statusCode",500),p.header("code",500),void p.code(500).send({title:{status:!1,statusCode:500,mode:"Maintenance mode"},status:!1,statusCode:500,statusrun:0,cache:"no cache",nameservice:"Micro service tppy-tcas",message:"Maintenance mode , Sorry for the inconvenience",message_th:"อยู่ระหว่างปรับปรุงระบบ ขออภัยความไม่สะดวก"})}catch(e){}var s=f.body,t=s.username,a=s.user_id,o=s.oldpassword,r=s.newpassword;if(""===t)return p.header("Access-Control-Allow-Methods","GET"),p.header("message","Information Correct"),p.header("statusCode",500),p.header("code",500),p.header("status",!1),p.code(500).send({title:{status:!1,statusCode:500},message:"username is null",message_th:"ไม่พบข้อมูล username"}),void console.log(f.body);if(""===o)return p.header("Access-Control-Allow-Methods","GET"),p.header("message","Information Correct"),p.header("statusCode",500),p.header("code",500),p.header("status",!1),p.code(500).send({title:{status:!1,statusCode:500},message:"old password is null",message_th:"ไม่พบข้อมูล old password"}),void console.log(f.body);if(""===r)return p.header("Access-Control-Allow-Methods","GET"),p.header("message","Information Correct"),p.header("statusCode",500),p.header("code",500),p.header("status",!1),p.code(500).send({title:{status:!1,statusCode:500},message:"new password is null",message_th:"ไม่พบข้อมูล new password"}),void console.log(f.body);e=C(20),s=j(r);if(0==s)return p.header("version",1),p.header("x-cache-status",0),p.header("Cache-Control","private, no-cache, no-store, must-revalidate"),p.header("Expires","-1"),p.header("Pragma","no-cache"),p.header("Access-Control-Allow-Methods","GET,POST,PUT"),p.header("message","Password not secure"),p.header("statusCode",500),p.header("code",500),p.header("status",!1),p.header("Password",!1),p.code(500).send({title:{status:!1,statusCode:500,cache:"no cache"},message:"Password not secure ,Please set a new password, English only, with uppercase, lowercase, numbers and special characters.,mix together",message_th:" รหัสผ่าน ไม่ปลอดภัย กรุณาตั้งรหัสผ่านใหม่ เป็นภาษาอังกฤษเท่านั้น ตัวพิมพ์ใหญ่ ตัวพิมพ์เล็ก ตัวเลข และอักขระพิเศษ ผสมกัน",generate_password:e}),void console.log(" passwordrt :"+s);try{const v={};v.username=t,v.user_id=a,v.oldpassword=o,v.newpassword=r;var d=crypto.createHash("md5").update(o).digest("hex"),n=crypto.createHash("md5").update(r).digest("hex");if(!(0<(yield x.login(S,t,d)).length))return p.header("Access-Control-Allow-Methods","GET"),p.header("message","Information Correct"),p.header("statusCode",401),p.header("code",401),p.header("status",!1),void p.code(401).send({status:!1,statusCode:401,message:"change password failed! ",message_th:"เปลี่ยนรหัสผ่านไม่สำเร็จ ไม่พบข้อมูล username หรือ password ในระบบ"});{const _={};_.password=n,_.password_temp=r,yield x.where_user_update_password(S,t,_)}var i=yield x.login(S,t,n);if(0<i.length){var c=i[0];console.log(c);var h=env.TIMEEXPIRE,u=(env.TIMEEXPIRE,new Date),l=u.getFullYear()+"-"+(u.getMonth()+1)+"-"+u.getDate()+" "+(u.getHours()+":"+u.getMinutes()+":"+u.getSeconds()),m=Date.now(),g=(Date.now(),O.jwt.sign({user_id:c.user_id,level:c.level,username:c.username,email:c.email,at:{startdate:l,issued_at:m,timeconfig:h,TIMEEXPIRE_TOKEN:env.TIMEEXPIRE_TOKEN,state:G(32)}}));O.jwt.verify(g);O.jwt.verify(g,(e,s)=>{e&&O.log.error(e),O.log.info("Token verified. Foo is "+s.foo)});c.user_id,c.username,c.email,c.firstname,c.lastname,c.level;return p.header("Access-Control-Allow-Methods","GET"),p.header("message","Information Correct"),p.header("statusCode",200),p.header("code",200),p.header("status",!0),void p.send({title:{status:!0,statusCode:200,cache:"no cache"},message:"Change password done welcome "+c.firstname+" "+c.lastname+" Sign in system successfully",message_th:" เปลี่ยนรหัสผ่าน สำเร็จ ยินดีต้อนรับ คุณ "+c.firstname+" "+c.lastname+" เข้าสู่ระบบสำเร็จ",token:g})}return void p.code(401).send({status:!1,statusCode:401,message:"Change password and Login failed or user is not active ! ",message_th:"ไม่พบข้อมูล username หรือ password ในระบบ หรือ ยัง ไม่ได้ active user"})}catch(e){return console.log(e),p.header("Access-Control-Allow-Methods","GET"),p.header("message","Information Correct"),p.header("statusCode",500),p.header("code",500),p.header("status",!1),void p.code(500).send({title:{status:!1,statusCode:500},message:e})}})),O.post("/changeemail",{preValidation:[O.authenticate],schema:changeemailSchema_1.default},(r,d)=>__awaiter(this,void 0,void 0,function*(){var e=env.mode;try{if(1!=e)return d.header("status",!1),d.header("statusCode",500),d.header("code",500),void d.code(500).send({title:{status:!1,statusCode:500,mode:"Maintenance mode"},status:!1,statusCode:500,statusrun:0,cache:"no cache",nameservice:"Micro service tppy-tcas",message:"Maintenance mode , Sorry for the inconvenience",message_th:"อยู่ระหว่างปรับปรุงระบบ ขออภัยความไม่สะดวก"})}catch(e){}var s=r.body,t=s.email,a=t,e=s.emailold;if(""===t)return d.header("Access-Control-Allow-Methods","GET"),d.header("message","Information Correct"),d.header("statusCode",500),d.header("code",500),d.header("status",!1),d.code(500).send({title:{status:!1,statusCode:500},message:"email is null",message_th:"ไม่พบข้อมูล email"}),void console.log(r.body);if(""===e)return d.header("Access-Control-Allow-Methods","GET"),d.header("message","Information Correct"),d.header("statusCode",500),d.header("code",500),d.header("status",!1),d.code(500).send({title:{status:!1,statusCode:500},message:"old email is null",message_th:"ไม่พบข้อมูล  email เดิม"}),void console.log(r.body);if(""===e)return d.header("Access-Control-Allow-Methods","GET"),d.header("message","Information Correct"),d.header("statusCode",500),d.header("code",500),d.header("status",!1),d.code(500).send({title:{status:!1,statusCode:500},message:"new email is null",message_th:"ไม่พบข้อมูล new email"}),void console.log(r.body);s=EmailValidator.validate(t);if(0==s)return d.header("Access-Control-Allow-Methods","POST"),d.header("statusCode",500),d.header("status",!1),void d.code(500).send({status:!1,statusCode:500,emailchk:s,message:"This email is Invalid format ",message_th:"รูปแบบ email ไม่ถูกต้อง"});if(0<(yield x.validation_email(S,t)).length)return d.header("Access-Control-Allow-Methods","POST"),d.header("statusCode",500),d.header("status",!1),void d.code(500).send({title:{status:!1,statusCode:500,cache:"no cache"},message:"This email is duplicate data in the database system ",message_th:"email นี้เป็นข้อมูลซ้ำในระบบฐานข้อมูล"});try{const o={};return o.email=a,yield x.where_user_update_mail(S,e,o),d.header("Access-Control-Allow-Methods","GET"),d.header("message","Information Correct"),d.header("statusCode",200),d.header("code",200),d.header("status",!0),void d.send({title:{status:!0,statusCode:200,cache:"no cache"},message:"Change email successfully",message_th:" เปลี่ยนรหัส email สำเร็จ "})}catch(e){return console.log(e),d.header("Access-Control-Allow-Methods","GET"),d.header("message","Information Correct"),d.header("statusCode",500),d.header("code",500),d.header("status",!1),void d.code(500).send({title:{status:!1,statusCode:500},message:e})}})),O.post("/activecode",{preValidation:[O.authenticate]},(n,i)=>__awaiter(this,void 0,void 0,function*(){var e=n.body.code;if(""===e)return i.header("Access-Control-Allow-Methods","GET"),i.header("message","Information Correct"),i.header("statusCode",500),i.header("code",500),i.header("status",!1),i.code(500).send({title:{status:!1,statusCode:500},message:"code is null",message_th:"ไม่พบข้อมูล code"}),void console.log(n.body);try{n.id;var s=O.jwt.verify(e),t=s.user_id,a=yield x.sd_users_profile(S,t),o=s.level,r=s.username;const d={status:1};return yield x.updateuid(S,t,d),i.header("Access-Control-Allow-Methods","POST"),i.header("message","Information Correct"),i.header("statusCode",200),i.header("code",200),i.header("status",!0),void i.send({title:{status:200,statusCode:200,cache:"no cache"},data:{error:null,user_id:t,level:o,username:r},sd_users_profile:a})}catch(e){return console.log(e),i.header("Access-Control-Allow-Methods","POST"),i.header("message","Information Correct"),i.header("code",500),void i.code(500).send({title:{title:{status:!1,statusCode:500},message:"Results unsuccessful",message_th:"แสดง ข้อมูลไม่สำเร็จ",cache:"no cache"},error:e,data:null})}})),O.get("/activecode",{preValidation:[O.authenticate]},(i,c)=>__awaiter(this,void 0,void 0,function*(){i.body;const e=i.query.code;var s=e;if(""==e)return c.header("Access-Control-Allow-Methods","GET"),c.header("message","Information Correct"),c.header("statusCode",500),c.header("status",!1),c.code(500).send({status:!1,statusCode:500,message:"code is null",message_th:"ไม่พบข้อมูล code"}),void console.log(i.body);try{i.id;var t=O.jwt.verify(s),a=t.user_id,o=yield x.sd_users_profile(S,a),r=t.level,d=t.username;const e=200,n={status:1};return yield x.updateuid(S,a,n),c.header("Access-Control-Allow-Methods","GET"),c.header("message","Information Correct"),c.header("statusCode",200),c.header("status",!0),void c.send({title:{status:!0,statusCode:200},data:{error:null,expired_status:1,user_id:a,level:r,username:d},sd_users_profile:o})}catch(e){return console.log(e),c.header("Access-Control-Allow-Methods","GET"),c.header("message","Information Correct"),c.header("statusCode",500),c.header("status",!1),void c.code(500).send({title:{status:!1,statusCode:500,message:"Results unsuccessful",message_th:"แสดง ข้อมูลไม่สำเร็จ",cache:"no cache"},error:e,data:null})}})),O.post("/verify",{preValidation:[O.authenticate]},(n,i)=>__awaiter(this,void 0,void 0,function*(){n.headers,n.body,n.query;const e=n.headers.authorization;var s=e.replace("Bearer ",""),t=O.jwt.verify(s);const a={};var o=(a.token=t).iat,r=t.exp;a.start_token=o;var d=(a.end_token=r)-o,o=(Date.now(),(new Date).getTime()),o=Math.round(o/1e3),o=r-(a.now=o);a.time_expire_setting=d,a.expire_in=o,a.token=s,a.decode=t,i.header("version",1),i.header("x-cache-status",0),i.header("code",200),i.code(200).send({title:{status:!0,statusCode:200},message:"jwt verify",message_th:"ถอดรหัส jwt",data:a})})),O.post("/verifyauthen",{preValidation:[O.authenticate]},(n,i)=>__awaiter(this,void 0,void 0,function*(){n.headers,n.body,n.query;const e=n.headers.authorization;var s=e.replace("Bearer ",""),t=O.jwt.verify(s);const a={};var o=(a.token=t).iat,r=t.exp;a.start_token=o;var d=(a.end_token=r)-o,o=(Date.now(),(new Date).getTime()),o=Math.round(o/1e3),o=r-(a.now=o);a.time_expire_setting=d,a.expire_in=o,a.token=s,a.decode=t,i.header("version",1),i.header("x-cache-status",0),i.header("code",200),i.code(200).send({title:{status:!0,statusCode:200},message:"jwt verify",message_th:"ถอดรหัส jwt",data:a})})),O.route({method:"GET",url:"/testopts",schema:{querystring:{name:{type:"string"},excitement:{type:"integer"}},response:{200:{type:"object",properties:{hello:{type:"string"}}}}},handler:function(e,s){s.header("Access-Control-Allow-Methods","GET"),s.header("message","Information Correct"),s.header("statusCode",200),s.header("status",!0),s.header("lang","th"),s.send({hello:"world"})}}),O.get("/test_handler_schema",{handler(e,s){e.body;var t=e.query,a=t.id,o=t.name,e=t.image;if(""==a)return s.header("Access-Control-Allow-Methods","GET"),s.header("message","Information Correct"),s.header("statusCode",500),s.header("status",!1),s.code(500).send({title:{status:!1,statusCode:500},message:"id is null and id must is number only",message_th:"ไม่พบข้อมูล id type id ต้องเป็นตัวเลขเท่านั้น"}),void console.log(t);s.header("Access-Control-Allow-Methods","GET"),s.header("message","Information Correct"),s.header("statusCode",200),s.header("status",!0),s.send({id:a,name:o,image:e})},schema:{response:{"2xx":{id:{type:"number"},name:{type:"string"}}}}}),O.get("/mode",(e,s)=>__awaiter(this,void 0,void 0,function*(){s.header("version",1),s.header("x-cache-status",0),s.header("Cache-Control","private, no-cache, no-store, must-revalidate"),s.header("Expires","-1"),s.header("Pragma","no-cache"),s.header("Access-Control-Allow-Methods","GET,POST,PUT"),s.header("message","Working"),s.header("status",!0),s.header("statusCode",200),s.header("code",200),s.code(200).send({status:!0,statusCode:200,statusrun:1,cache:"no cache",nameservice:"Micro service tppy-tcas",message:"The system works in normal mode.",message_th:"ระบบทำงาน ในโหมดปกติ"}),console.log(e.body)})),O.post("/jwtsingin",(d,n)=>__awaiter(this,void 0,void 0,function*(){var e=d.headers,s=d.body,t=(d.query,e.authorization,s.time||TIMEEXPIRE||"10h"),a=O.jwt.sign({name:"demo",expirein:t},{expiresIn:t}),o=O.jwt.decode(a);const r={};r.token=a,r.decoded=o,r.expirein=t,n.header("version",1),n.header("x-cache-status",0),n.header("code",200),n.code(200).send({title:{status:!0,statusCode:200},message:"jwt sign",message_th:"เข้ารหัสรหัส jwt",data:r,timeset:"10h",body:s,expire_in:t,headers:e})})),O.post("/jwtverify",{preValidation:[O.authenticate]},(n,i)=>__awaiter(this,void 0,void 0,function*(){n.headers,n.body,n.query;const e=n.headers.authorization;var s=e.replace("Bearer ",""),t=O.jwt.verify(s);const a={};var o=(a.token=t).iat,r=t.exp;a.start_token=o;var d=(a.end_token=r)-o,o=(Date.now(),(new Date).getTime()),o=Math.round(o/1e3),o=r-(a.now=o);a.time_expire_setting=d,a.expire_in=o,a.token=s,a.decode=t,i.header("version",1),i.header("x-cache-status",0),i.header("code",200),i.code(200).send({title:{status:!0,statusCode:200},message:"jwt verify",message_th:"ถอดรหัส jwt",data:a})})),O.post("/accesstoken",{schema:accesstokenSchema_1.default},(l,m)=>__awaiter(this,void 0,void 0,function*(){var e=path.join(__dirname,"../configrouter.conf");require("dotenv").config({path:e});var s=process.env,t=(s.TIMEEXPIRE,s.TIMEEXPIRE_TOKEN),a=(s.mode,s.client_id),o=s.access_token_key,r=s.secret_key,e=(s.scopenumber,l.headers),s=l.body,t=(l.query,e.authorization,s.time||t||"10h");try{var d=s.client_id;if(null===d)return m.header("accesstoken",""),m.header("statusCode",500),m.header("status",!1),m.header("message","forbidden access"),void m.code(500).send({message:"client_id is empty ,forbidden access ",message_th:"ไม่พบ client_id ไม่อนุญาตให้เข้าถึง ระบบ"});if(d!=a)return m.header("accesstoken",""),m.header("statusCode",500),m.header("status",!1),m.header("message","forbidden access"),void m.code(500).send({message:"client_id is incorrect ,forbidden access ",message_th:"client_id ไม่ถูกต้อง ไม่อนุญาตให้เข้าถึง"});var n=s.secret_key;if(null===n)return m.header("accesstoken",""),m.header("statusCode",500),m.header("status",!1),m.header("message","forbidden access"),void m.code(500).send({message:"secret_key is empty ,forbidden access ",message_th:"ไม่พบ secret_key ไม่อนุญาตให้เข้าถึง ระบบ"});if(n!=r)return m.header("accesstoken",""),m.header("statusCode",500),m.header("status",!1),m.header("message","forbidden access"),void m.code(500).send({message:"secret_key is incorrect ,forbidden access ",message_th:"secret_key ไม่ถูกต้อง ไม่อนุญาตให้เข้าถึง"});var i=s.access_token_key;if(null===i)return m.header("accesstoken",""),m.header("statusCode",500),m.header("status",!1),m.header("message","forbidden access"),void m.code(500).send({message:"secret_key is empty ,forbidden access ",message_th:"ไม่พบ secret_key ไม่อนุญาตให้เข้าถึง ระบบ"});if(i!=o)return m.header("accesstoken",""),m.header("statusCode",500),m.header("status",!1),m.header("message","forbidden access"),void m.code(500).send({message:"access_token_key is incorrect ,forbidden access ",message_th:"access_token_key ไม่ถูกต้อง ไม่อนุญาตให้เข้าถึง"});var c=O.jwt.sign({status_allow:1,allow_message:"welcome to api",expirein:t},{expiresIn:t}),h=O.jwt.decode(c);const u={};u.token=c,u.decoded=h,u.expirein=t,m.header("version",1),m.header("x-cache-status",0),m.header("code",200),m.code(200).send({title:{status:!0,statusCode:200},message:"allow api welcome",message_th:"อนุญาต ให้เข้าถึง ระบบ api ยินดีต้อนรับ",token:c,timeset:"10h"})}catch(e){return m.header("accesstoken",""),m.header("statusCode",500),m.header("status",!1),m.header("message",e),void m.code(500).send({resporn:"forbidden access",message:e})}})),O.post("/private",{preValidation:[O.authenticate]},(e,s)=>__awaiter(this,void 0,void 0,function*(){s.header("version",1),s.header("x-cache-status",0),s.header("Cache-Control","private, no-cache, no-store, must-revalidate"),s.header("Expires","-1"),s.header("Pragma","no-cache"),s.header("Access-Control-Allow-Methods","GET,POST,PUT"),s.header("message","Working"),s.header("code",200),s.header("status",!0),s.send({title:{message:"Allow Protected area!  allow access to the system",message_th:"Protected area อนุญาตให้เข้าถึงระบบ!",status:!0,status_int:1,statusCode:200},body:{data:null}})})),O.post("/signtest",(e,s)=>__awaiter(this,void 0,void 0,function*(){var e=G(36),e=O.jwt.sign({data:e});s.header("version",1),s.header("x-cache-status",0),s.header("Cache-Control","private, no-cache, no-store, must-revalidate"),s.header("Expires","-1"),s.header("Pragma","no-cache"),s.header("Access-Control-Allow-Methods","GET,POST,PUT"),s.header("message","Working"),s.header("code",200),s.header("status",!0),s.send({title:{message:"Create token",message_th:"สร้างโทเค็น",status:!0,status_int:1,statusCode:200},token:e})}))})}exports.default=auth;