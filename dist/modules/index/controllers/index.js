"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,s){void 0===s&&(s=a),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[a]}})}:function(e,t,a,s){e[s=void 0===s?a:s]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t},__awaiter=this&&this.__awaiter||function(e,n,d,i){return new(d=d||Promise)(function(a,t){function s(e){try{o(i.next(e))}catch(e){t(e)}}function r(e){try{o(i.throw(e))}catch(e){t(e)}}function o(e){var t;e.done?a(e.value):((t=e.value)instanceof d?t:new d(function(e){e(t)})).then(s,r)}o((i=i.apply(e,n||[])).next())})},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const path=__importStar(require("path")),envPath=path.join(__dirname,"../../../config.conf");require("dotenv").config({path:envPath});const env=process.env,mode=env.mode,accesstokenSchema_1=__importDefault(require("../../../schemas/accesstokenSchema"));function index(l){return __awaiter(this,void 0,void 0,function*(){l.post("/",(e,t)=>__awaiter(this,void 0,void 0,function*(){var e=env.mode;t.header("version",1),t.header("x-cache-status",0),t.header("Cache-Control","private, no-cache, no-store, must-revalidate"),t.header("Expires","-1"),t.header("Pragma","no-cache"),t.header("Access-Control-Allow-Methods","GET,POST,PUT"),t.header("message","Working"),1==e?(t.header("status",!0),t.header("statusCode",200),t.header("code",200),t.code(200).send({title:{status:!0,statusCode:200,mode:"service"},status:!0,statusCode:200,statusrun:1,cache:"no cache",nameservice:"Micro service tppy-tcas",message:"The system works in normal mode.",message_th:"ระบบทำงาน ในโหมดปกติ"})):(t.header("status",!1),t.header("statusCode",500),t.header("code",500),t.code(500).send({title:{status:!1,statusCode:500,mode:"Maintenance mode"},status:!1,statusCode:500,statusrun:0,cache:"no cache",nameservice:"Micro service tppy-tcas",message:"Maintenance mode , Sorry for the inconvenience",message_th:"อยู่ระหว่างปรับปรุงระบบ ขออภัยความไม่สะดวก"}))})),l.get("/",(t,a)=>__awaiter(this,void 0,void 0,function*(){var e=env.mode;a.header("version",1),a.header("x-cache-status",0),a.header("Cache-Control","private, no-cache, no-store, must-revalidate"),a.header("Expires","-1"),a.header("Pragma","no-cache"),a.header("Access-Control-Allow-Methods","GET,POST,PUT"),a.header("message","Working"),1==e?(a.header("status",!0),a.header("statusCode",200),a.header("code",200),a.code(200).send({title:{status:!0,statusCode:200,mode:"service"},status:!0,statusCode:200,statusrun:1,cache:"no cache",nameservice:"Micro service tppy-tcas",message:"The system works in normal mode.",message_th:"ระบบทำงาน ในโหมดปกติ"})):(a.header("status",!1),a.header("statusCode",500),a.header("code",500),a.code(500).send({title:{status:!1,statusCode:500,mode:"Maintenance mode"},status:!1,statusCode:500,statusrun:0,cache:"no cache",nameservice:"Micro service tppy-tcas",message:"Maintenance mode , Sorry for the inconvenience",message_th:"อยู่ระหว่างปรับปรุงระบบ ขออภัยความไม่สะดวก"})),console.log(t.body)})),l.post("/ui",(e,t)=>__awaiter(this,void 0,void 0,function*(){t.header("version",1),t.header("x-cache-status",0),t.header("Cache-Control","private, no-cache, no-store, must-revalidate"),t.header("Expires","-1"),t.header("Pragma","no-cache"),t.header("Access-Control-Allow-Methods","GET,POST,PUT"),t.header("message","Working"),t.header("code",200),t.header("status",!0),t.send({title:{message:"Welcome to tppy-tcas!",message_th:"tppy-tcas ยินดีตอนรับ!",status:!0,status_int:1,statusCode:200,version:"1.0.0",author:"kongnakornjantakun@gmail.com"},body:{data:null,error:null}})})),l.get("/ui",(e,t)=>__awaiter(this,void 0,void 0,function*(){t.view("/views/index",{message:"Welcome to tppy-tcas!"})})),l.post("/jwt/signtest",(e,t)=>__awaiter(this,void 0,void 0,function*(){var e=l.jwt.sign({username:"Kongnakorn",password:"Jantakun"});t.header("version",1),t.header("x-cache-status",0),t.header("Cache-Control","private, no-cache, no-store, must-revalidate"),t.header("Expires","-1"),t.header("Pragma","no-cache"),t.header("Access-Control-Allow-Methods","GET,POST,PUT"),t.header("message","Working"),t.header("code",200),t.header("status",!0),t.send({title:{message:"Create token",message_th:"สร้างโทเค็น",status:!0,status_int:1,statusCode:200},token:e})})),l.post("/jwt/private",{preValidation:[l.authenticate]},(e,t)=>__awaiter(this,void 0,void 0,function*(){t.header("version",1),t.header("x-cache-status",0),t.header("Cache-Control","private, no-cache, no-store, must-revalidate"),t.header("Expires","-1"),t.header("Pragma","no-cache"),t.header("Access-Control-Allow-Methods","GET,POST,PUT"),t.header("message","Working"),t.header("code",200),t.header("status",!0),t.send({title:{message:"Allow Protected area!  allow access to the system",message_th:"Protected area อนุญาตให้เข้าถึงระบบ!",status:!0,status_int:1,statusCode:200},body:{data:null}})})),l.post("/jwt/authentication",{preValidation:[l.authenticate]},(d,i)=>__awaiter(this,void 0,void 0,function*(){d.headers,d.body,d.query;const e=d.headers.authorization;var t=e.replace("Bearer ",""),a=l.jwt.verify(t);const s={};var r=(s.token=a).iat,o=a.exp;s.start_token=r;var n=(s.end_token=o)-r,r=(Date.now(),(new Date).getTime()),r=Math.round(r/1e3),r=o-(s.now=r);s.time_expire_setting=n,s.expire_in=r,s.token=t,s.decode=a,i.header("version",1),i.header("x-cache-status",0),i.header("code",200),i.code(200).send({title:{status:!0,statusCode:200},message:"jwt verify",message_th:"ถอดรหัส jwt",data:s})})),l.post("/jwtverify",{preValidation:[l.authenticate]},(d,i)=>__awaiter(this,void 0,void 0,function*(){d.headers,d.body,d.query;const e=d.headers.authorization;var t=e.replace("Bearer ",""),a=l.jwt.verify(t);const s={};var r=(s.token=a).iat,o=a.exp;s.start_token=r;var n=(s.end_token=o)-r,r=(Date.now(),(new Date).getTime()),r=Math.round(r/1e3),r=o-(s.now=r);s.time_expire_setting=n,s.expire_in=r,s.token=t,s.decode=a,i.header("version",1),i.header("x-cache-status",0),i.header("code",200),i.code(200).send({title:{status:!0,statusCode:200},message:"jwt verify",message_th:"ถอดรหัส jwt",data:s})})),l.post("/accesstoken",{schema:accesstokenSchema_1.default},(m,_)=>__awaiter(this,void 0,void 0,function*(){var e=path.join(__dirname,"../configrouter.conf");require("dotenv").config({path:e});var t=process.env,a=(t.TIMEEXPIRE,t.TIMEEXPIRE_TOKEN),s=(t.mode,t.client_id),r=t.access_token_key,o=t.secret_key,e=(t.scopenumber,m.headers),t=m.body,a=(m.query,e.authorization,t.time||a||"10h");try{var n=t.client_id;if(null===n)return _.header("accesstoken",""),_.header("statusCode",500),_.header("status",!1),_.header("message","forbidden access"),void _.code(500).send({message:"client_id is empty ,forbidden access ",message_th:"ไม่พบ client_id ไม่อนุญาตให้เข้าถึง ระบบ"});if(n!=s)return _.header("accesstoken",""),_.header("statusCode",500),_.header("status",!1),_.header("message","forbidden access"),void _.code(500).send({message:"client_id is incorrect ,forbidden access ",message_th:"client_id ไม่ถูกต้อง ไม่อนุญาตให้เข้าถึง"});var d=t.secret_key;if(null===d)return _.header("accesstoken",""),_.header("statusCode",500),_.header("status",!1),_.header("message","forbidden access"),void _.code(500).send({message:"secret_key is empty ,forbidden access ",message_th:"ไม่พบ secret_key ไม่อนุญาตให้เข้าถึง ระบบ"});if(d!=o)return _.header("accesstoken",""),_.header("statusCode",500),_.header("status",!1),_.header("message","forbidden access"),void _.code(500).send({message:"secret_key is incorrect ,forbidden access ",message_th:"secret_key ไม่ถูกต้อง ไม่อนุญาตให้เข้าถึง"});var i=t.access_token_key;if(null===i)return _.header("accesstoken",""),_.header("statusCode",500),_.header("status",!1),_.header("message","forbidden access"),void _.code(500).send({message:"secret_key is empty ,forbidden access ",message_th:"ไม่พบ secret_key ไม่อนุญาตให้เข้าถึง ระบบ"});if(i!=r)return _.header("accesstoken",""),_.header("statusCode",500),_.header("status",!1),_.header("message","forbidden access"),void _.code(500).send({message:"access_token_key is incorrect ,forbidden access ",message_th:"access_token_key ไม่ถูกต้อง ไม่อนุญาตให้เข้าถึง"});var c=l.jwt.sign({status_allow:1,allow_message:"welcome to api",expirein:a},{expiresIn:a}),h=l.jwt.decode(c);const u={};u.token=c,u.decoded=h,u.expirein=a,_.header("version",1),_.header("x-cache-status",0),_.header("code",200),_.code(200).send({title:{status:!0,statusCode:200},message:"allow api welcome",message_th:"อนุญาต ให้เข้าถึง ระบบ api ยินดีต้อนรับ",token:c,timeset:"10h"})}catch(e){return _.header("accesstoken",""),_.header("statusCode",500),_.header("status",!1),_.header("message",e),void _.code(500).send({resporn:"forbidden access",message:e})}}))})}exports.default=index;