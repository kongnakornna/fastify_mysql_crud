"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,a){void 0===a&&(a=s),Object.defineProperty(e,a,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,a){e[a=void 0===a?s:a]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t},__awaiter=this&&this.__awaiter||function(e,n,i,d){return new(i=i||Promise)(function(s,t){function a(e){try{r(d.next(e))}catch(e){t(e)}}function o(e){try{r(d.throw(e))}catch(e){t(e)}}function r(e){var t;e.done?s(e.value):((t=e.value)instanceof i?t:new i(function(e){e(t)})).then(a,o)}r((d=d.apply(e,n||[])).next())})},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const crypto=__importStar(require("crypto")),path=__importStar(require("path")),envPath=path.join(__dirname,"../configrouter.conf");require("dotenv").config({path:envPath});const env=process.env,opts={},TIMEEXPIRE=env.TIMEEXPIRE,mode=env.mode,util=require("util"),singinSchema_1=__importDefault(require("../modules/auth/schemas/singinSchema")),typeorm_1=require("typeorm"),Sd_users_entities_1=require("../entities/Sd_users.entities"),Sduser_repository_1=require("../repositories/Sduser.repository");function access(y){return __awaiter(this,void 0,void 0,function*(){function p(e){for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()_+",s="",a=0;a<e;a++)s+=t.charAt(Math.floor(Math.random()*t.length));return s}y.get("/",(e,t)=>__awaiter(this,void 0,void 0,function*(){var e=env.mode;t.header("version",1),t.header("x-cache-status",0),t.header("Cache-Control","private, no-cache, no-store, must-revalidate"),t.header("Expires","-1"),t.header("Pragma","no-cache"),t.header("Access-Control-Allow-Methods","GET,POST,PUT"),t.header("message","Working"),1==e?(t.header("status",!0),t.header("statusCode",200),t.header("code",200),t.code(200).send({title:{status:!0,statusCode:200,mode:"service"},status:!0,statusCode:200,statusrun:1,cache:"no cache",nameservice:"Micro service tppy-tcas",message:"The system works in normal mode.",message_th:"ระบบทำงาน ในโหมดปกติ"})):(t.header("status",!1),t.header("statusCode",500),t.header("code",500),t.code(500).send({title:{status:!1,statusCode:500,mode:"Maintenance mode"},status:!1,statusCode:500,statusrun:0,cache:"no cache",nameservice:"Micro service tppy-tcas",message:"Maintenance mode , Sorry for the inconvenience",message_th:"อยู่ระหว่างปรับปรุงระบบ ขออภัยความไม่สะดวก"}))})),y.post("/",(e,t)=>__awaiter(this,void 0,void 0,function*(){var e=env.mode;t.header("version",1),t.header("x-cache-status",0),t.header("Cache-Control","private, no-cache, no-store, must-revalidate"),t.header("Expires","-1"),t.header("Pragma","no-cache"),t.header("Access-Control-Allow-Methods","GET,POST,PUT"),t.header("message","Working"),1==e?(t.header("status",!0),t.header("statusCode",200),t.header("code",200),t.code(200).send({title:{status:!0,statusCode:200,mode:"service"},status:!0,statusCode:200,statusrun:1,cache:"no cache",nameservice:"Micro service tppy-tcas",message:"The system works in normal mode.",message_th:"ระบบทำงาน ในโหมดปกติ"})):(t.header("status",!1),t.header("statusCode",500),t.header("code",500),t.code(500).send({title:{status:!1,statusCode:500,mode:"Maintenance mode"},status:!1,statusCode:500,statusrun:0,cache:"no cache",nameservice:"Micro service tppy-tcas",message:"Maintenance mode , Sorry for the inconvenience",message_th:"อยู่ระหว่างปรับปรุงระบบ ขออภัยความไม่สะดวก"}))})),y.post("/test",{schema:singinSchema_1.default},(f,v)=>__awaiter(this,void 0,void 0,function*(){var e=f.body,t=e.username,s=e.password;console.log(e);try{if(""==t)return v.header("Access-Control-Allow-Methods","GET"),v.header("message","Information Correct"),v.header("statusCode",500),v.header("status",!1),v.code(500).send({title:{status:!1,statusCode:500},message:"username is null",message_th:"ไม่พบข้อมูล username"}),void console.log(f.body);if(""==s)return v.header("Access-Control-Allow-Methods","GET"),v.header("message","Information Correct"),v.header("statusCode",500),v.header("status",!1),v.code(500).send({title:{status:!1,statusCode:500},message:"password is null",message_th:"ไม่พบข้อมูล password"}),void console.log(f.body);var a=crypto.createHash("md5").update(s).digest("hex");Number(1);const g=(0,typeorm_1.getCustomRepository)(Sduser_repository_1.SduserRepository);var o=yield g.finduser(t,a);console.log("typeorm is QueryBuilder : ",util.inspect(" data : "+o,{showHidden:!0,depth:!0,colors:!0}));var r=o[0],n={idx:r.user_id,username:r.username,email:r.email,firstName:r.firstname,lastName:r.lastname,level:r.level,profile_id:r.profile_id},i=o.length;if(1<=i){var d=o,c=(env.TIMEEXPIRE,env.TIMEEXPIRE);const _=new Date;var u=_.getFullYear()+"-"+(_.getMonth()+1)+"-"+_.getDate()+" "+(_.getHours()+":"+_.getMinutes()+":"+_.getSeconds()),l=Date.now(),h=(Date.now(),l+c),m=y.jwt.sign({profile:n,at:{startdate:u,issued_at:l,time_expired:h,time_setting:c,day_expired:1,timeconfig:TIMEEXPIRE,state:p(32)}});y.jwt.verify(m);return y.jwt.verify(m,(e,t)=>{e&&y.log.error(e),y.log.info("Token verified. Foo is "+t.foo)}),v.header("Access-Control-Allow-Methods","GET"),v.header("message","Information Correct"),v.header("statusCode",200),v.header("status",!0),void v.send({title:{status:!0,statusCode:200,cache:"no cache"},message:"welcome "+d.firstname+" "+d.lastname+" Sign in system successfully",message_th:"ยินดีต้อนรับ คุณ "+d.firstname+" "+d.lastname+" เข้าสู่ระบบสำเร็จ",TIMEEXPIRE:env.TIMEEXPIRE,token:m})}return void v.code(400).send({title:{status:!1,statusCode:400,cache:"no cache"},message:"information username "+t+" not found in the system! or incorrect information",message_th:"ไม่พบข้อมูล username "+t+" ในระบบ หรือ ข้อมูลไม่ถูกต้อง",count:i})}catch(e){return console.log(e),v.header("status",!1),v.header("statusCode",500),v.header("code",500),void v.code(500).send({code:500,status:!1,error:e,message:"error data not found in the system!",message_th:" ไม่พบข้อมูล หรือ ระบบทำงานล้มเหลว",data:null})}})),y.post("/singin",{schema:singinSchema_1.default},(f,v)=>__awaiter(this,void 0,void 0,function*(){var e=f.body,t=e.username,s=e.password;console.log(e);try{if(""==t)return v.header("Access-Control-Allow-Methods","GET"),v.header("message","Information Correct"),v.header("statusCode",500),v.header("status",!1),v.code(500).send({title:{status:!1,statusCode:500},message:"username is null",message_th:"ไม่พบข้อมูล username"}),void console.log(f.body);if(""==s)return v.header("Access-Control-Allow-Methods","GET"),v.header("message","Information Correct"),v.header("statusCode",500),v.header("status",!1),v.code(500).send({title:{status:!1,statusCode:500},message:"password is null",message_th:"ไม่พบข้อมูล password"}),void console.log(f.body);var a=crypto.createHash("md5").update(s).digest("hex");Number(1);const g=(0,typeorm_1.getCustomRepository)(Sduser_repository_1.SduserRepository);var o=yield g.finduser(t,a);console.log("typeorm is QueryBuilder : ",util.inspect(" data : "+o,{showHidden:!0,depth:!0,colors:!0}));var r=o[0],n={idx:r.user_id,username:r.username,email:r.email,firstName:r.firstname,lastName:r.lastname,level:r.level,profile_id:r.profile_id},i=o.length;if(1<=i){var d=o,c=(env.TIMEEXPIRE,env.TIMEEXPIRE);const _=new Date;var u=_.getFullYear()+"-"+(_.getMonth()+1)+"-"+_.getDate()+" "+(_.getHours()+":"+_.getMinutes()+":"+_.getSeconds()),l=Date.now(),h=(Date.now(),l+c),m=y.jwt.sign({profile:n,at:{startdate:u,issued_at:l,time_expired:h,time_setting:c,day_expired:1,timeconfig:TIMEEXPIRE,state:p(32)}});y.jwt.verify(m);return y.jwt.verify(m,(e,t)=>{e&&y.log.error(e),y.log.info("Token verified. Foo is "+t.foo)}),v.header("Access-Control-Allow-Methods","GET"),v.header("message","Information Correct"),v.header("statusCode",200),v.header("status",!0),void v.send({title:{status:!0,statusCode:200,cache:"no cache"},message:"welcome "+d.firstname+" "+d.lastname+" Sign in system successfully",message_th:"ยินดีต้อนรับ คุณ "+d.firstname+" "+d.lastname+" เข้าสู่ระบบสำเร็จ",TIMEEXPIRE:env.TIMEEXPIRE,token:m})}return void v.code(400).send({title:{status:!1,statusCode:400,cache:"no cache"},message:"information username "+t+" not found in the system! or incorrect information",message_th:"ไม่พบข้อมูล username "+t+" ในระบบ หรือ ข้อมูลไม่ถูกต้อง",count:i})}catch(e){return console.log(e),v.header("status",!1),v.header("statusCode",500),v.header("code",500),void v.code(500).send({code:500,status:!1,error:e,message:"error data not found in the system!",message_th:" ไม่พบข้อมูล หรือ ระบบทำงานล้มเหลว",data:null})}})),y.post("/login",{schema:singinSchema_1.default},(_,f)=>__awaiter(this,void 0,void 0,function*(){var e=_.body,t=e.username,s=e.password;console.log(e);try{if(""==t)return f.header("Access-Control-Allow-Methods","GET"),f.header("message","Information Correct"),f.header("statusCode",500),f.header("status",!1),f.code(500).send({title:{status:!1,statusCode:500},message:"username is null",message_th:"ไม่พบข้อมูล username"}),void console.log(_.body);if(""==s)return f.header("Access-Control-Allow-Methods","GET"),f.header("message","Information Correct"),f.header("statusCode",500),f.header("status",!1),f.code(500).send({title:{status:!1,statusCode:500},message:"password is null",message_th:"ไม่พบข้อมูล password"}),void console.log(_.body);var a=crypto.createHash("md5").update(s).digest("hex"),o=yield(0,typeorm_1.getRepository)(Sd_users_entities_1.Sd_users).createQueryBuilder("Sd_users").select("SUM(Sd_users.user_id)","sum").select(["Sd_users.profile_id","Sd_users.user_id AS Sd_users_uid","Sd_users.user_id","Sd_users.username","Sd_users.email","Sd_users.firstname","Sd_users.lastname","Sd_users.fullname","Sd_users.level"]).where("Sd_users.username = :username",{username:t}).andWhere("Sd_users.password = :password",{password:a}).andWhere("Sd_users.status = :status",{status:1}).getMany();console.log("typeorm is QueryBuilder : ",util.inspect(" data : "+o,{showHidden:!0,depth:!0,colors:!0}));var r=o[0],n={idx:r.user_id,username:r.username,email:r.email,firstName:r.firstname,lastName:r.lastname,level:r.level,profile_id:r.profile_id},i=o.length;if(1<=i){var d=o,c=(env.TIMEEXPIRE,env.TIMEEXPIRE);const g=new Date;var u=g.getFullYear()+"-"+(g.getMonth()+1)+"-"+g.getDate()+" "+(g.getHours()+":"+g.getMinutes()+":"+g.getSeconds()),l=Date.now(),h=(Date.now(),l+c),m=y.jwt.sign({profile:n,at:{startdate:u,issued_at:l,time_expired:h,time_setting:c,day_expired:1,timeconfig:TIMEEXPIRE,state:p(32)}});y.jwt.verify(m);return y.jwt.verify(m,(e,t)=>{e&&y.log.error(e),y.log.info("Token verified. Foo is "+t.foo)}),f.header("Access-Control-Allow-Methods","GET"),f.header("message","Information Correct"),f.header("statusCode",200),f.header("status",!0),void f.send({title:{status:!0,statusCode:200,cache:"no cache"},message:"welcome "+d.firstname+" "+d.lastname+" Sign in system successfully",message_th:"ยินดีต้อนรับ คุณ "+d.firstname+" "+d.lastname+" เข้าสู่ระบบสำเร็จ",TIMEEXPIRE:env.TIMEEXPIRE,token:m})}return void f.code(400).send({title:{status:!1,statusCode:400,cache:"no cache"},message:"information username "+t+" not found in the system! or incorrect information",message_th:"ไม่พบข้อมูล username "+t+" ในระบบ หรือ ข้อมูลไม่ถูกต้อง",count:i})}catch(e){return console.log(e),f.header("status",!1),f.header("statusCode",500),f.header("code",500),void f.code(500).send({code:500,status:!1,error:e,message:"error data not found in the system!",message_th:" ไม่พบข้อมูล หรือ ระบบทำงานล้มเหลว",data:null})}})),y.post("/authentication",(o,r)=>__awaiter(this,void 0,void 0,function*(){var e=o.body.token;if(""==e)return r.header("Access-Control-Allow-Methods","GET"),r.header("message","Information Correct"),r.header("statusCode",500),r.header("status",!1),r.code(500).send({title:{status:!1,statusCode:500},message:"token is null",message_th:"ไม่พบข้อมูล token"}),void console.log(o.body);var t=y.jwt.verify(e),s=t.at,a=(s.startdate,s.issued_at),e=100*s.time_setting;s.time_expired,s.day_expired,s.timeconfig,s.state;if(e<Date.now()-a)return r.header("Access-Control-Allow-Methods","GET"),r.header("message","Information Correct"),r.header("statusCode",500),r.header("status",!1),void r.send({title:{status:!1,statusCode:500,message:"Token Expired ",msg_time_th:"โทเค็นหมดอายุ",cache:"no cache"},data:null});r.header("Access-Control-Allow-Methods","GET"),r.header("message","Information Correct"),r.header("statusCode",200),r.header("status",!0),r.code(200).send({title:{status:!0,statusCode:200,message:"Authentication successful",message_th:"Authentication สำเร็จ",cache:"no cache"},data:t.profile})})),y.get("/genint",{preValidation:[y.genint]},(e,t)=>__awaiter(this,void 0,void 0,function*(){})),y.post("/genint",{preValidation:[y.genint]},(e,t)=>__awaiter(this,void 0,void 0,function*(){})),y.get("/getstate",{preValidation:[y.getstate]},(e,t)=>__awaiter(this,void 0,void 0,function*(){})),y.post("/getstate",{preValidation:[y.getstate]},(e,t)=>__awaiter(this,void 0,void 0,function*(){})),y.get("/clientsecret",{preValidation:[y.clientsecret]},(e,t)=>__awaiter(this,void 0,void 0,function*(){})),y.post("/clientsecret",{preValidation:[y.clientsecret]},(e,t)=>__awaiter(this,void 0,void 0,function*(){})),y.get("/codegenclientid",{preValidation:[y.codegen]},(e,t)=>__awaiter(this,void 0,void 0,function*(){})),y.post("/codegenclientid",{preValidation:[y.codegen]},(e,t)=>__awaiter(this,void 0,void 0,function*(){})),y.get("/mode",(e,t)=>__awaiter(this,void 0,void 0,function*(){t.header("version",1),t.header("x-cache-status",0),t.header("Cache-Control","private, no-cache, no-store, must-revalidate"),t.header("Expires","-1"),t.header("Pragma","no-cache"),t.header("Access-Control-Allow-Methods","GET,POST,PUT"),t.header("message","Working"),t.header("status",!0),t.header("statusCode",200),t.header("code",200),t.code(200).send({status:!0,statusCode:200,statusrun:1,cache:"no cache",nameservice:"Micro service tppy-tcas",message:"The system works in normal mode.",message_th:"ระบบทำงาน ในโหมดปกติ"}),console.log(e.body)}))})}exports.default=access;