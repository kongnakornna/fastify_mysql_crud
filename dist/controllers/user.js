"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,a){void 0===a&&(a=s),Object.defineProperty(e,a,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,a){e[a=void 0===a?s:a]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t},__awaiter=this&&this.__awaiter||function(e,n,i,d){return new(i=i||Promise)(function(s,t){function a(e){try{r(d.next(e))}catch(e){t(e)}}function o(e){try{r(d.throw(e))}catch(e){t(e)}}function r(e){var t;e.done?s(e.value):((t=e.value)instanceof i?t:new i(function(e){e(t)})).then(a,o)}r((d=d.apply(e,n||[])).next())})},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const crypto=__importStar(require("crypto")),path=__importStar(require("path")),envPath=path.join(__dirname,"../.env");require("dotenv").config({path:envPath});const env=process.env,opts={},TIMEEXPIRE=env.TIMEEXPIRE,mode=env.mode,util=require("util"),singinSchema_1=__importDefault(require("../modules/auth/schemas/singinSchema")),generatetokenSchema_1=__importDefault(require("../schemas/generatetokenSchema")),accesstokenSchema_1=__importDefault(require("../schemas/accesstokenSchema")),typeorm_1=require("typeorm"),Sduser_repository_1=require("../repositories/Sduser.repository");function user(k){return __awaiter(this,void 0,void 0,function*(){function E(e){for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()_+",s="",a=0;a<e;a++)s+=t.charAt(Math.floor(Math.random()*t.length));return s}k.get("/genint",{preValidation:[k.genint]},(e,t)=>__awaiter(this,void 0,void 0,function*(){})),k.post("/genint",{preValidation:[k.genint]},(e,t)=>__awaiter(this,void 0,void 0,function*(){})),k.get("/getstate",{preValidation:[k.getstate]},(e,t)=>__awaiter(this,void 0,void 0,function*(){})),k.post("/getstate",{preValidation:[k.getstate]},(e,t)=>__awaiter(this,void 0,void 0,function*(){})),k.get("/clientsecret",{preValidation:[k.clientsecret]},(e,t)=>__awaiter(this,void 0,void 0,function*(){})),k.post("/clientsecret",{preValidation:[k.clientsecret]},(e,t)=>__awaiter(this,void 0,void 0,function*(){})),k.get("/codegenclientid",{preValidation:[k.codegen]},(e,t)=>__awaiter(this,void 0,void 0,function*(){})),k.post("/codegenclientid",{preValidation:[k.codegen]},(e,t)=>__awaiter(this,void 0,void 0,function*(){})),k.post("/verifytoken",{preValidation:[k.authenticate]},(i,d)=>__awaiter(this,void 0,void 0,function*(){i.headers,i.body,i.query;const e=i.headers.authorization;var t=e.replace("Bearer ",""),s=k.jwt.verify(t);const a={};var o=(a.token=s).iat,r=s.exp;a.start_token=o;var n=(a.end_token=r)-o,o=(Date.now(),(new Date).getTime()),o=Math.round(o/1e3),o=r-(a.now=o);a.time_expire_setting=n,a.expire_in=o,a.token=t,a.decode=s,d.header("version",1),d.header("x-cache-status",0),d.header("code",200),d.code(200).send({title:{status:!0,statusCode:200},message:"jwt verify",message_th:"ถอดรหัส jwt",data:a})})),k.post("/accesstoken",{schema:accesstokenSchema_1.default},(l,m)=>__awaiter(this,void 0,void 0,function*(){var e=path.join(__dirname,"../configrouter.conf");require("dotenv").config({path:e});var t=process.env,s=(t.TIMEEXPIRE,t.TIMEEXPIRE_TOKEN),a=(t.mode,t.client_id),o=t.access_token_key,r=t.secret_key,e=(t.scopenumber,l.headers),t=l.body,s=(l.query,e.authorization,t.time||s||"10h");try{var n=t.client_id;if(null===n)return m.header("accesstoken",""),m.header("statusCode",500),m.header("status",!1),m.header("message","forbidden access"),void m.code(500).send({message:"client_id is empty ,forbidden access ",message_th:"ไม่พบ client_id ไม่อนุญาตให้เข้าถึง ระบบ"});if(n!=a)return m.header("accesstoken",""),m.header("statusCode",500),m.header("status",!1),m.header("message","forbidden access"),void m.code(500).send({message:"client_id is incorrect ,forbidden access ",message_th:"client_id ไม่ถูกต้อง ไม่อนุญาตให้เข้าถึง"});var i=t.secret_key;if(null===i)return m.header("accesstoken",""),m.header("statusCode",500),m.header("status",!1),m.header("message","forbidden access"),void m.code(500).send({message:"secret_key is empty ,forbidden access ",message_th:"ไม่พบ secret_key ไม่อนุญาตให้เข้าถึง ระบบ"});if(i!=r)return m.header("accesstoken",""),m.header("statusCode",500),m.header("status",!1),m.header("message","forbidden access"),void m.code(500).send({message:"secret_key is incorrect ,forbidden access ",message_th:"secret_key ไม่ถูกต้อง ไม่อนุญาตให้เข้าถึง"});var d=t.access_token_key;if(null===d)return m.header("accesstoken",""),m.header("statusCode",500),m.header("status",!1),m.header("message","forbidden access"),void m.code(500).send({message:"secret_key is empty ,forbidden access ",message_th:"ไม่พบ secret_key ไม่อนุญาตให้เข้าถึง ระบบ"});if(d!=o)return m.header("accesstoken",""),m.header("statusCode",500),m.header("status",!1),m.header("message","forbidden access"),void m.code(500).send({message:"access_token_key is incorrect ,forbidden access ",message_th:"access_token_key ไม่ถูกต้อง ไม่อนุญาตให้เข้าถึง"});var c=k.jwt.sign({status_allow:1,allow_message:"welcome to api",expirein:s},{expiresIn:s}),u=k.jwt.decode(c);const h={};h.token=c,h.decoded=u,h.expirein=s,m.header("version",1),m.header("x-cache-status",0),m.header("code",200),m.code(200).send({title:{status:!0,statusCode:200},message:"allow api welcome",message_th:"อนุญาต ให้เข้าถึง ระบบ api ยินดีต้อนรับ",token:c,timeset:"10h"})}catch(e){return m.header("accesstoken",""),m.header("statusCode",500),m.header("status",!1),m.header("message",e),void m.code(500).send({resporn:"forbidden access",message:e})}})),k.post("/jwtverify",{preValidation:[k.authenticate]},(i,d)=>__awaiter(this,void 0,void 0,function*(){i.headers,i.body,i.query;const e=i.headers.authorization;var t=e.replace("Bearer ",""),s=k.jwt.verify(t);const a={};var o=(a.token=s).iat,r=s.exp;a.start_token=o;var n=(a.end_token=r)-o,o=(Date.now(),(new Date).getTime()),o=Math.round(o/1e3),o=r-(a.now=o);a.time_expire_setting=n,a.expire_in=o,a.token=t,a.decode=s,d.header("version",1),d.header("x-cache-status",0),d.header("code",200),d.code(200).send({title:{status:!0,statusCode:200},message:"jwt verify",message_th:"ถอดรหัส jwt",data:a})})),k.post("/privateallow",{preValidation:[k.authenticate]},(e,t)=>__awaiter(this,void 0,void 0,function*(){t.header("version",1),t.header("x-cache-status",0),t.header("Cache-Control","private, no-cache, no-store, must-revalidate"),t.header("Expires","-1"),t.header("Pragma","no-cache"),t.header("Access-Control-Allow-Methods","GET,POST,PUT"),t.header("message","Working"),t.header("code",200),t.header("status",!0),t.send({title:{message:"Allow Protected area!  allow access to the system",message_th:"Protected area อนุญาตให้เข้าถึงระบบ!",status:!0,status_int:1,statusCode:200},body:{data:null}})})),k.post("/gentoken",(e,t)=>__awaiter(this,void 0,void 0,function*(){var e=E(36),e=k.jwt.sign({data:e});t.header("version",1),t.header("x-cache-status",0),t.header("Cache-Control","private, no-cache, no-store, must-revalidate"),t.header("Expires","-1"),t.header("Pragma","no-cache"),t.header("Access-Control-Allow-Methods","GET,POST,PUT"),t.header("message","Working"),t.header("code",200),t.header("status",!0),t.send({title:{message:"Create token",message_th:"สร้างโทเค็น",status:!0,status_int:1,statusCode:200},token:e})})),k.get("/",(e,t)=>__awaiter(this,void 0,void 0,function*(){var e=env.mode;t.header("version",1),t.header("x-cache-status",0),t.header("Cache-Control","private, no-cache, no-store, must-revalidate"),t.header("Expires","-1"),t.header("Pragma","no-cache"),t.header("Access-Control-Allow-Methods","GET,POST,PUT"),t.header("message","Working"),1==e?(t.header("status",!0),t.header("statusCode",200),t.header("code",200),t.code(200).send({title:{status:!0,statusCode:200,mode:"service"},status:!0,statusCode:200,statusrun:1,cache:"no cache",nameservice:"Micro service tppy-tcas",message:"The system works in normal mode.",message_th:"ระบบทำงาน ในโหมดปกติ"})):(t.header("status",!1),t.header("statusCode",500),t.header("code",500),t.code(500).send({title:{status:!1,statusCode:500,mode:"Maintenance mode"},status:!1,statusCode:500,statusrun:0,cache:"no cache",nameservice:"Micro service tppy-tcas",message:"Maintenance mode , Sorry for the inconvenience",message_th:"อยู่ระหว่างปรับปรุงระบบ ขออภัยความไม่สะดวก"}))})),k.post("/",(e,t)=>__awaiter(this,void 0,void 0,function*(){var e=env.mode;t.header("version",1),t.header("x-cache-status",0),t.header("Cache-Control","private, no-cache, no-store, must-revalidate"),t.header("Expires","-1"),t.header("Pragma","no-cache"),t.header("Access-Control-Allow-Methods","GET,POST,PUT"),t.header("message","Working"),1==e?(t.header("status",!0),t.header("statusCode",200),t.header("code",200),t.code(200).send({title:{status:!0,statusCode:200,mode:"service"},status:!0,statusCode:200,statusrun:1,cache:"no cache",nameservice:"Micro service tppy-tcas",message:"The system works in normal mode.",message_th:"ระบบทำงาน ในโหมดปกติ"})):(t.header("status",!1),t.header("statusCode",500),t.header("code",500),t.code(500).send({title:{status:!1,statusCode:500,mode:"Maintenance mode"},status:!1,statusCode:500,statusrun:0,cache:"no cache",nameservice:"Micro service tppy-tcas",message:"Maintenance mode , Sorry for the inconvenience",message_th:"อยู่ระหว่างปรับปรุงระบบ ขออภัยความไม่สะดวก"}))})),k.post("/test",{schema:singinSchema_1.default},(v,f)=>__awaiter(this,void 0,void 0,function*(){var e=v.body,t=e.username,s=e.password;console.log(e);try{if(""==t)return f.header("Access-Control-Allow-Methods","GET"),f.header("message","Information Correct"),f.header("statusCode",500),f.header("status",!1),f.code(500).send({title:{status:!1,statusCode:500},message:"username is null",message_th:"ไม่พบข้อมูล username"}),void console.log(v.body);if(""==s)return f.header("Access-Control-Allow-Methods","GET"),f.header("message","Information Correct"),f.header("statusCode",500),f.header("status",!1),f.code(500).send({title:{status:!1,statusCode:500},message:"password is null",message_th:"ไม่พบข้อมูล password"}),void console.log(v.body);var a=crypto.createHash("md5").update(s).digest("hex");Number(1);const _=(0,typeorm_1.getCustomRepository)(Sduser_repository_1.SduserRepository);var o=yield _.finduser(t,a);console.log("typeorm is QueryBuilder : ",util.inspect(" data : "+o,{showHidden:!0,depth:!0,colors:!0}));var r=o[0],n={idx:r.user_id,username:r.username,email:r.email,firstName:r.firstname,lastName:r.lastname,level:r.level,profile_id:r.profile_id},i=o.length;if(1<=i){var d=o,c=(env.TIMEEXPIRE,env.TIMEEXPIRE);const g=new Date;var u=g.getFullYear()+"-"+(g.getMonth()+1)+"-"+g.getDate()+" "+(g.getHours()+":"+g.getMinutes()+":"+g.getSeconds()),h=Date.now(),l=(Date.now(),h+c),m=k.jwt.sign({profile:n,at:{startdate:u,issued_at:h,time_expired:l,time_setting:c,day_expired:1,timeconfig:TIMEEXPIRE,state:E(32)}});k.jwt.verify(m);return k.jwt.verify(m,(e,t)=>{e&&k.log.error(e),k.log.info("Token verified. Foo is "+t.foo)}),f.header("Access-Control-Allow-Methods","GET"),f.header("message","Information Correct"),f.header("statusCode",200),f.header("status",!0),void f.send({title:{status:!0,statusCode:200,cache:"no cache"},message:"welcome "+d.firstname+" "+d.lastname+" Sign in system successfully",message_th:"ยินดีต้อนรับ คุณ "+d.firstname+" "+d.lastname+" เข้าสู่ระบบสำเร็จ",TIMEEXPIRE:env.TIMEEXPIRE,token:m})}return void f.code(400).send({title:{status:!1,statusCode:400,cache:"no cache"},message:"information username "+t+" not found in the system! or incorrect information",message_th:"ไม่พบข้อมูล username "+t+" ในระบบ หรือ ข้อมูลไม่ถูกต้อง",count:i})}catch(e){return console.log(e),f.header("status",!1),f.header("statusCode",500),f.header("code",500),void f.code(500).send({code:500,status:!1,error:e,message:"error data not found in the system!",message_th:" ไม่พบข้อมูล หรือ ระบบทำงานล้มเหลว",data:null})}})),k.post("/generatetoken",{schema:generatetokenSchema_1.default},(v,f)=>__awaiter(this,void 0,void 0,function*(){var e=v.body,t=e.username,s=e.password;console.log(e);try{if(""==t)return f.header("Access-Control-Allow-Methods","GET"),f.header("message","Information Correct"),f.header("statusCode",500),f.header("status",!1),f.code(500).send({title:{status:!1,statusCode:500},message:"username is null",message_th:"ไม่พบข้อมูล username"}),void console.log(v.body);if(""==s)return f.header("Access-Control-Allow-Methods","GET"),f.header("message","Information Correct"),f.header("statusCode",500),f.header("status",!1),f.code(500).send({title:{status:!1,statusCode:500},message:"password is null",message_th:"ไม่พบข้อมูล password"}),void console.log(v.body);var a=crypto.createHash("md5").update(s).digest("hex");Number(1);const _=(0,typeorm_1.getCustomRepository)(Sduser_repository_1.SduserRepository);var o=yield _.finduser(t,a);console.log("typeorm is QueryBuilder : ",util.inspect(" data : "+o,{showHidden:!0,depth:!0,colors:!0}));var r=o[0],n={idx:r.user_id,username:r.username,email:r.email,firstName:r.firstname,lastName:r.lastname,level:r.level,profile_id:r.profile_id},i=o.length;if(1<=i){var d=o,c=(env.TIMEEXPIRE,env.TIMEEXPIRE);const g=new Date;var u=g.getFullYear()+"-"+(g.getMonth()+1)+"-"+g.getDate()+" "+(g.getHours()+":"+g.getMinutes()+":"+g.getSeconds()),h=Date.now(),l=(Date.now(),h+c),m=k.jwt.sign({profile:n,at:{startdate:u,issued_at:h,time_expired:l,time_setting:c,day_expired:1,timeconfig:TIMEEXPIRE,state:E(32)}});k.jwt.verify(m);return k.jwt.verify(m,(e,t)=>{e&&k.log.error(e),k.log.info("Token verified. Foo is "+t.foo)}),f.header("Access-Control-Allow-Methods","GET"),f.header("message","Information Correct"),f.header("statusCode",200),f.header("status",!0),void f.send({title:{status:!0,statusCode:200,cache:"no cache"},message:"welcome "+d.firstname+" "+d.lastname+" Sign in system successfully",message_th:"ยินดีต้อนรับ คุณ "+d.firstname+" "+d.lastname+" เข้าสู่ระบบสำเร็จ",TIMEEXPIRE:env.TIMEEXPIRE,token:m})}return void f.code(400).send({title:{status:!1,statusCode:400,cache:"no cache"},message:"information username "+t+" not found in the system! or incorrect information",message_th:"ไม่พบข้อมูล username "+t+" ในระบบ หรือ ข้อมูลไม่ถูกต้อง",count:i})}catch(e){return console.log(e),f.header("status",!1),f.header("statusCode",500),f.header("code",500),void f.code(500).send({code:500,status:!1,error:e,message:"error data not found in the system!",message_th:" ไม่พบข้อมูล หรือ ระบบทำงานล้มเหลว",data:null})}})),k.post("/singin",{schema:singinSchema_1.default},(w,C)=>__awaiter(this,void 0,void 0,function*(){var e=path.join(__dirname,"../configrouter.conf");require("dotenv").config({path:e});var t=process.env,s=(t.TIMEEXPIRE,t.TIMEEXPIRE_TOKEN),a=(t.mode,t.client_id,t.access_token_key,t.secret_key),o=(t.scopenumber,w.headers),r=w.body,e=(w.query,o.authorization,r.time),o=e||s||"10h",e=(t.mode,r.username),s=r.password;console.log(r);try{var n=r.secret_key;if(null===n)return C.header("accesstoken",""),C.header("statusCode",500),C.header("status",!1),C.header("message","forbidden access"),void C.code(500).send({message:"secret_key is empty ,forbidden access ",message_th:"ไม่พบ secret_key ไม่อนุญาตให้เข้าถึง ระบบ"});if(n!=a)return C.header("accesstoken",""),C.header("statusCode",500),C.header("status",!1),C.header("message","forbidden access"),void C.code(500).send({message:"secret_key is incorrect ,forbidden access ",message_th:"secret_key ไม่ถูกต้อง ไม่อนุญาตให้เข้าถึง"});if(""==e)return C.header("Access-Control-Allow-Methods","GET"),C.header("message","Information Correct"),C.header("statusCode",500),C.header("status",!1),C.code(500).send({title:{status:!1,statusCode:500},message:"username is null",message_th:"ไม่พบข้อมูล username"}),void console.log(w.body);if(""==s)return C.header("Access-Control-Allow-Methods","GET"),C.header("message","Information Correct"),C.header("statusCode",500),C.header("status",!1),C.code(500).send({title:{status:!1,statusCode:500},message:"password is null",message_th:"ไม่พบข้อมูล password"}),void console.log(w.body);var i=crypto.createHash("md5").update(s).digest("hex");Number(1);const v=(0,typeorm_1.getCustomRepository)(Sduser_repository_1.SduserRepository);var d=yield v.singinuser(e,i);console.log("typeorm is QueryBuilder : ",util.inspect(" data : "+d,{showHidden:!0,depth:!0,colors:!0}));var c=d[0],u=(c.user_id,c.username,c.email,c.firstname,c.lastname,c.level,c.profile_id,d.length);if(1<=u){var h=d;t.TIMEEXPIRE,t.TIMEEXPIRE;const f=new Date;var l=f.getFullYear()+"-"+(f.getMonth()+1)+"-"+f.getDate();const p=f.getHours()+":"+f.getMinutes()+":"+f.getSeconds();p,Date.now(),Date.now();var m=h[0];console.log(m);var _=k.jwt.sign({user_idx:m.user_id,profile_id:m.profile_id,level:m.level,username:m.username,email:m.email,firstName:m.firstname,lastName:m.lastname,state:E(32),expirein:o},{expiresIn:o}),g=k.jwt.verify(_);const y={};y.token=_,y.decoded=g,y.expirein=o,C.header("version",1),C.header("x-cache-status",0),C.header("code",200),k.jwt.verify(_,(e,t)=>{e&&k.log.error(e),k.log.info("Token verified. Foo is "+t.foo)});m.user_id,m.username,m.email,m.firstname,m.lastname,m.level;return C.header("Access-Control-Allow-Methods","GET"),C.header("message","Information Correct"),C.header("statusCode",200),C.header("status",!0),void C.send({title:{status:!0,statusCode:200,cache:"no cache"},message:"welcome "+m.firstname+" "+m.lastname+" Sign in system successfully",message_th:"ยินดีต้อนรับ คุณ "+m.firstname+" "+m.lastname+" เข้าสู่ระบบสำเร็จ",data:m,TIMEEXPIRE:t.TIMEEXPIRE,token:_})}return void C.code(400).send({title:{status:!1,statusCode:400,cache:"no cache"},message:"information username "+e+" not found in the system! or incorrect information",message_th:"ไม่พบข้อมูล username "+e+" ในระบบ หรือ ข้อมูลไม่ถูกต้อง",count:u})}catch(e){return console.log(e),C.header("status",!1),C.header("statusCode",500),C.header("code",500),void C.code(500).send({code:500,status:!1,error:e,message:"error data not found in the system!",message_th:" ไม่พบข้อมูล หรือ ระบบทำงานล้มเหลว",data:null})}})),k.post("/authentication",(i,d)=>__awaiter(this,void 0,void 0,function*(){i.headers,i.body,i.query;const e=i.headers.authorization;var t=e.replace("Bearer ",""),s=k.jwt.verify(t);const a={};var o=(a.token=s).iat,r=s.exp;a.start_token=o;var n=(a.end_token=r)-o,o=(Date.now(),(new Date).getTime()),o=Math.round(o/1e3),o=r-(a.now=o);a.time_expire_setting=n,a.expire_in=o,a.token=t,a.decode=s,d.header("version",1),d.header("x-cache-status",0),d.header("code",200),d.code(200).send({title:{status:!0,statusCode:200},message:"jwt verify",message_th:"ถอดรหัส jwt",data:a})})),k.get("/mode",(e,t)=>__awaiter(this,void 0,void 0,function*(){t.header("version",1),t.header("x-cache-status",0),t.header("Cache-Control","private, no-cache, no-store, must-revalidate"),t.header("Expires","-1"),t.header("Pragma","no-cache"),t.header("Access-Control-Allow-Methods","GET,POST,PUT"),t.header("message","Working"),t.header("status",!0),t.header("statusCode",200),t.header("code",200),t.code(200).send({status:!0,statusCode:200,statusrun:1,cache:"no cache",nameservice:"Micro service tppy-tcas",message:"The system works in normal mode.",message_th:"ระบบทำงาน ในโหมดปกติ"}),console.log(e.body)}))})}exports.default=user;