"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,a){void 0===a&&(a=s),Object.defineProperty(e,a,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,a){e[a=void 0===a?s:a]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t},__awaiter=this&&this.__awaiter||function(e,n,i,d){return new(i=i||Promise)(function(s,t){function a(e){try{r(d.next(e))}catch(e){t(e)}}function o(e){try{r(d.throw(e))}catch(e){t(e)}}function r(e){var t;e.done?s(e.value):((t=e.value)instanceof i?t:new i(function(e){e(t)})).then(a,o)}r((d=d.apply(e,n||[])).next())})},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const crypto=__importStar(require("crypto")),path=__importStar(require("path")),envPath=path.join(__dirname,"../.env");require("dotenv").config({path:envPath});const env=process.env,opts={},TIMEEXPIRE=env.TIMEEXPIRE,mode=env.mode,util=require("util"),singinSchema_1=__importDefault(require("../modules/auth/schemas/singinSchema")),generatetokenSchema_1=__importDefault(require("../schemas/generatetokenSchema")),typeorm_1=require("typeorm"),Adadmin_repository_1=require("../repositories/Adadmin.repository");function admin(y){return __awaiter(this,void 0,void 0,function*(){function p(e){for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()_+",s="",a=0;a<e;a++)s+=t.charAt(Math.floor(Math.random()*t.length));return s}y.get("/genint",{preValidation:[y.genint]},(e,t)=>__awaiter(this,void 0,void 0,function*(){})),y.post("/genint",{preValidation:[y.genint]},(e,t)=>__awaiter(this,void 0,void 0,function*(){})),y.get("/getstate",{preValidation:[y.getstate]},(e,t)=>__awaiter(this,void 0,void 0,function*(){})),y.post("/getstate",{preValidation:[y.getstate]},(e,t)=>__awaiter(this,void 0,void 0,function*(){})),y.get("/clientsecret",{preValidation:[y.clientsecret]},(e,t)=>__awaiter(this,void 0,void 0,function*(){})),y.post("/clientsecret",{preValidation:[y.clientsecret]},(e,t)=>__awaiter(this,void 0,void 0,function*(){})),y.get("/codegenclientid",{preValidation:[y.codegen]},(e,t)=>__awaiter(this,void 0,void 0,function*(){})),y.post("/codegenclientid",{preValidation:[y.codegen]},(e,t)=>__awaiter(this,void 0,void 0,function*(){})),y.get("/",(e,t)=>__awaiter(this,void 0,void 0,function*(){var e=env.mode;t.header("version",1),t.header("x-cache-status",0),t.header("Cache-Control","private, no-cache, no-store, must-revalidate"),t.header("Expires","-1"),t.header("Pragma","no-cache"),t.header("Access-Control-Allow-Methods","GET,POST,PUT"),t.header("message","Working"),1==e?(t.header("status",!0),t.header("statusCode",200),t.header("code",200),t.code(200).send({title:{status:!0,statusCode:200,mode:"service"},status:!0,statusCode:200,statusrun:1,cache:"no cache",nameservice:"Micro service tppy-tcas",message:"The system works in normal mode.",message_th:"ระบบทำงาน ในโหมดปกติ"})):(t.header("status",!1),t.header("statusCode",500),t.header("code",500),t.code(500).send({title:{status:!1,statusCode:500,mode:"Maintenance mode"},status:!1,statusCode:500,statusrun:0,cache:"no cache",nameservice:"Micro service tppy-tcas",message:"Maintenance mode , Sorry for the inconvenience",message_th:"อยู่ระหว่างปรับปรุงระบบ ขออภัยความไม่สะดวก"}))})),y.post("/",(e,t)=>__awaiter(this,void 0,void 0,function*(){var e=env.mode;t.header("version",1),t.header("x-cache-status",0),t.header("Cache-Control","private, no-cache, no-store, must-revalidate"),t.header("Expires","-1"),t.header("Pragma","no-cache"),t.header("Access-Control-Allow-Methods","GET,POST,PUT"),t.header("message","Working"),1==e?(t.header("status",!0),t.header("statusCode",200),t.header("code",200),t.code(200).send({title:{status:!0,statusCode:200,mode:"service"},status:!0,statusCode:200,statusrun:1,cache:"no cache",nameservice:"Micro service tppy-tcas",message:"The system works in normal mode.",message_th:"ระบบทำงาน ในโหมดปกติ"})):(t.header("status",!1),t.header("statusCode",500),t.header("code",500),t.code(500).send({title:{status:!1,statusCode:500,mode:"Maintenance mode"},status:!1,statusCode:500,statusrun:0,cache:"no cache",nameservice:"Micro service tppy-tcas",message:"Maintenance mode , Sorry for the inconvenience",message_th:"อยู่ระหว่างปรับปรุงระบบ ขออภัยความไม่สะดวก"}))})),y.post("/test",{schema:singinSchema_1.default},(v,_)=>__awaiter(this,void 0,void 0,function*(){var e=v.body,t=e.username,s=e.password;console.log(e);try{if(""==t)return _.header("Access-Control-Allow-Methods","GET"),_.header("message","Information Correct"),_.header("statusCode",500),_.header("status",!1),_.code(500).send({title:{status:!1,statusCode:500},message:"username is null",message_th:"ไม่พบข้อมูล username"}),void console.log(v.body);if(""==s)return _.header("Access-Control-Allow-Methods","GET"),_.header("message","Information Correct"),_.header("statusCode",500),_.header("status",!1),_.code(500).send({title:{status:!1,statusCode:500},message:"password is null",message_th:"ไม่พบข้อมูล password"}),void console.log(v.body);var a=crypto.createHash("md5").update(s).digest("hex");Number(1);const g=(0,typeorm_1.getCustomRepository)(Adadmin_repository_1.adminRepository);var o=yield g.finduser(t,a);console.log("typeorm is QueryBuilder : ",util.inspect(" data : "+o,{showHidden:!0,depth:!0,colors:!0}));var r=o[0],n={idx:r.user_id,username:r.username,email:r.email,firstName:r.firstname,lastName:r.lastname,level:r.level,profile_id:r.profile_id},i=o.length;if(1<=i){var d=o,c=(env.TIMEEXPIRE,env.TIMEEXPIRE);const f=new Date;var u=f.getFullYear()+"-"+(f.getMonth()+1)+"-"+f.getDate()+" "+(f.getHours()+":"+f.getMinutes()+":"+f.getSeconds()),h=Date.now(),l=(Date.now(),h+c),m=y.jwt.sign({profile:n,at:{startdate:u,issued_at:h,time_expired:l,time_setting:c,day_expired:1,timeconfig:TIMEEXPIRE,state:p(32)}});y.jwt.verify(m);return y.jwt.verify(m,(e,t)=>{e&&y.log.error(e),y.log.info("Token verified. Foo is "+t.foo)}),_.header("Access-Control-Allow-Methods","GET"),_.header("message","Information Correct"),_.header("statusCode",200),_.header("status",!0),void _.send({title:{status:!0,statusCode:200,cache:"no cache"},message:"welcome "+d.firstname+" "+d.lastname+" Sign in system successfully",message_th:"ยินดีต้อนรับ คุณ "+d.firstname+" "+d.lastname+" เข้าสู่ระบบสำเร็จ",TIMEEXPIRE:env.TIMEEXPIRE,token:m})}return void _.code(400).send({title:{status:!1,statusCode:400,cache:"no cache"},message:"information username "+t+" not found in the system! or incorrect information",message_th:"ไม่พบข้อมูล username "+t+" ในระบบ หรือ ข้อมูลไม่ถูกต้อง",count:i})}catch(e){return console.log(e),_.header("status",!1),_.header("statusCode",500),_.header("code",500),void _.code(500).send({code:500,status:!1,error:e,message:"error data not found in the system!",message_th:" ไม่พบข้อมูล หรือ ระบบทำงานล้มเหลว",data:null})}})),y.post("/generatetoken",{schema:generatetokenSchema_1.default},(v,_)=>__awaiter(this,void 0,void 0,function*(){var e=v.body,t=e.username,s=e.password;console.log(e);try{if(""==t)return _.header("Access-Control-Allow-Methods","GET"),_.header("message","Information Correct"),_.header("statusCode",500),_.header("status",!1),_.code(500).send({title:{status:!1,statusCode:500},message:"username is null",message_th:"ไม่พบข้อมูล username"}),void console.log(v.body);if(""==s)return _.header("Access-Control-Allow-Methods","GET"),_.header("message","Information Correct"),_.header("statusCode",500),_.header("status",!1),_.code(500).send({title:{status:!1,statusCode:500},message:"password is null",message_th:"ไม่พบข้อมูล password"}),void console.log(v.body);var a=crypto.createHash("md5").update(s).digest("hex");Number(1);const g=(0,typeorm_1.getCustomRepository)(Adadmin_repository_1.adminRepository);var o=yield g.finduser(t,a);console.log("typeorm is QueryBuilder : ",util.inspect(" data : "+o,{showHidden:!0,depth:!0,colors:!0}));var r=o[0],n={idx:r.user_id,username:r.username,email:r.email,firstName:r.firstname,lastName:r.lastname,level:r.level,profile_id:r.profile_id},i=o.length;if(1<=i){var d=o,c=(env.TIMEEXPIRE,env.TIMEEXPIRE);const f=new Date;var u=f.getFullYear()+"-"+(f.getMonth()+1)+"-"+f.getDate()+" "+(f.getHours()+":"+f.getMinutes()+":"+f.getSeconds()),h=Date.now(),l=(Date.now(),h+c),m=y.jwt.sign({profile:n,at:{startdate:u,issued_at:h,time_expired:l,time_setting:c,day_expired:1,timeconfig:TIMEEXPIRE,state:p(32)}});y.jwt.verify(m);return y.jwt.verify(m,(e,t)=>{e&&y.log.error(e),y.log.info("Token verified. Foo is "+t.foo)}),_.header("Access-Control-Allow-Methods","GET"),_.header("message","Information Correct"),_.header("statusCode",200),_.header("status",!0),void _.send({title:{status:!0,statusCode:200,cache:"no cache"},message:"welcome "+d.firstname+" "+d.lastname+" Sign in system successfully",message_th:"ยินดีต้อนรับ คุณ "+d.firstname+" "+d.lastname+" เข้าสู่ระบบสำเร็จ",TIMEEXPIRE:env.TIMEEXPIRE,token:m})}return void _.code(400).send({title:{status:!1,statusCode:400,cache:"no cache"},message:"information username "+t+" not found in the system! or incorrect information",message_th:"ไม่พบข้อมูล username "+t+" ในระบบ หรือ ข้อมูลไม่ถูกต้อง",count:i})}catch(e){return console.log(e),_.header("status",!1),_.header("statusCode",500),_.header("code",500),void _.code(500).send({code:500,status:!1,error:e,message:"error data not found in the system!",message_th:" ไม่พบข้อมูล หรือ ระบบทำงานล้มเหลว",data:null})}})),y.post("/singin",{schema:singinSchema_1.default},(v,_)=>__awaiter(this,void 0,void 0,function*(){var e=v.body,t=e.username,s=e.password;console.log(e);try{if(""==t)return _.header("Access-Control-Allow-Methods","GET"),_.header("message","Information Correct"),_.header("statusCode",500),_.header("status",!1),_.code(500).send({title:{status:!1,statusCode:500},message:"username is null",message_th:"ไม่พบข้อมูล username"}),void console.log(v.body);if(""==s)return _.header("Access-Control-Allow-Methods","GET"),_.header("message","Information Correct"),_.header("statusCode",500),_.header("status",!1),_.code(500).send({title:{status:!1,statusCode:500},message:"password is null",message_th:"ไม่พบข้อมูล password"}),void console.log(v.body);var a=crypto.createHash("md5").update(s).digest("hex");Number(1);const g=(0,typeorm_1.getCustomRepository)(Adadmin_repository_1.adminRepository);var o=yield g.finduser(t,a);console.log("typeorm is QueryBuilder : ",util.inspect(" data : "+o,{showHidden:!0,depth:!0,colors:!0}));var r=o[0],n={idx:r.user_id,username:r.username,email:r.email,firstName:r.firstname,lastName:r.lastname,level:r.level,profile_id:r.profile_id},i=o.length;if(1<=i){var d=o,c=(env.TIMEEXPIRE,env.TIMEEXPIRE);const f=new Date;var u=f.getFullYear()+"-"+(f.getMonth()+1)+"-"+f.getDate()+" "+(f.getHours()+":"+f.getMinutes()+":"+f.getSeconds()),h=Date.now(),l=(Date.now(),h+c),m=y.jwt.sign({profile:n,at:{startdate:u,issued_at:h,time_expired:l,time_setting:c,day_expired:1,timeconfig:TIMEEXPIRE,state:p(32)}});y.jwt.verify(m);return y.jwt.verify(m,(e,t)=>{e&&y.log.error(e),y.log.info("Token verified. Foo is "+t.foo)}),_.header("Access-Control-Allow-Methods","GET"),_.header("message","Information Correct"),_.header("statusCode",200),_.header("status",!0),void _.send({title:{status:!0,statusCode:200,cache:"no cache"},message:"welcome "+d.firstname+" "+d.lastname+" Sign in system successfully",message_th:"ยินดีต้อนรับ คุณ "+d.firstname+" "+d.lastname+" เข้าสู่ระบบสำเร็จ",TIMEEXPIRE:env.TIMEEXPIRE,token:m})}return void _.code(400).send({title:{status:!1,statusCode:400,cache:"no cache"},message:"information username "+t+" not found in the system! or incorrect information",message_th:"ไม่พบข้อมูล username "+t+" ในระบบ หรือ ข้อมูลไม่ถูกต้อง",count:i})}catch(e){return console.log(e),_.header("status",!1),_.header("statusCode",500),_.header("code",500),void _.code(500).send({code:500,status:!1,error:e,message:"error data not found in the system!",message_th:" ไม่พบข้อมูล หรือ ระบบทำงานล้มเหลว",data:null})}})),y.post("/authentication",(r,n)=>__awaiter(this,void 0,void 0,function*(){var e=r.body.token,t=r.headers.authorization.replace("Bearer ",""),s=y.jwt.verify(t);if(""==e)return n.header("Access-Control-Allow-Methods","GET"),n.header("message","Information Correct"),n.header("statusCode",500),n.header("status",!1),n.code(500).send({title:{status:!1,statusCode:500},message:"token is null",message_th:"ไม่พบข้อมูล token"}),void console.log(r.body);var a=s,o=a.at,t=(o.startdate,o.issued_at),s=100*o.time_setting;o.time_expired,o.day_expired,o.timeconfig,o.state;if(s<Date.now()-t)return n.header("Access-Control-Allow-Methods","GET"),n.header("message","Information Correct"),n.header("statusCode",500),n.header("status",!1),void n.send({title:{status:!1,statusCode:500,message:"Token Expired ",msg_time_th:"โทเค็นหมดอายุ",cache:"no cache"}});n.header("Access-Control-Allow-Methods","GET"),n.header("message","Information Correct"),n.header("statusCode",200),n.header("status",!0),n.code(200).send({title:{status:!0,statusCode:200,message:"Authentication successful",message_th:"Authentication สำเร็จ",cache:"no cache"},rs:a,token:e,data:a.profile})})),y.get("/mode",(e,t)=>__awaiter(this,void 0,void 0,function*(){t.header("version",1),t.header("x-cache-status",0),t.header("Cache-Control","private, no-cache, no-store, must-revalidate"),t.header("Expires","-1"),t.header("Pragma","no-cache"),t.header("Access-Control-Allow-Methods","GET,POST,PUT"),t.header("message","Working"),t.header("status",!0),t.header("statusCode",200),t.header("code",200),t.code(200).send({status:!0,statusCode:200,statusrun:1,cache:"no cache",nameservice:"Micro service tppy-tcas",message:"The system works in normal mode.",message_th:"ระบบทำงาน ในโหมดปกติ"}),console.log(e.body)}))})}exports.default=admin;